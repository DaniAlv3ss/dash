<script>
// ==================================================================
// === LÓGICA DA PÁGINA DE INCOMPATIBILIDADES =======================
// ==================================================================

// Variáveis globais para a tabela principal
let allIncompatibilidadeRows = [];
let filteredIncompatibilidadeRows = [];
let incompatCurrentPage = 1;
const incompatRowsPerPage = 20;
let filterTimeoutIncompat;

// Variáveis globais para a tabela do modal do técnico
let allTecnicoCasos = [];
let tecnicoCurrentPage = 1;
const tecnicoRowsPerPage = 10;

// NOVO: Variáveis para ordenação da tabela de todos os técnicos
let allTecnicosSortCol = 'producao';
let allTecnicosSortDir = 'desc';

function initializeIncompatibilidadePage() {
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(() => {
        try {
            const today = new Date();
            const firstDayMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('incompat-endDate').value = today.toISOString().split('T')[0];
            document.getElementById('incompat-startDate').value = firstDayMonth.toISOString().split('T')[0];
            
            document.getElementById('incompat-applyButton').addEventListener('click', applyIncompatDateFilter);
            document.getElementById('incompat-date-range-toggle').addEventListener('click', (e) => toggleDatePopup(e, 'incompat-date-range-popup'));
            document.getElementById('incompat-cancelButton').addEventListener('click', (e) => toggleDatePopup(e, 'incompat-date-range-popup'));
            updateIncompatDateRangeDisplay();
            
            document.getElementById('incompat-prev-page').addEventListener('click', () => {
                if (incompatCurrentPage > 1) {
                    incompatCurrentPage--;
                    renderIncompatibilidadeTablePage();
                }
            });
            document.getElementById('incompat-next-page').addEventListener('click', () => {
                if (incompatCurrentPage * incompatRowsPerPage < filteredIncompatibilidadeRows.length) {
                    incompatCurrentPage++;
                    renderIncompatibilidadeTablePage();
                }
            });

            document.getElementById('tecnico-casos-prev-page').addEventListener('click', () => {
                if (tecnicoCurrentPage > 1) {
                    tecnicoCurrentPage--;
                    renderTecnicoCasosPage();
                }
            });
            document.getElementById('tecnico-casos-next-page').addEventListener('click', () => {
                if (tecnicoCurrentPage * tecnicoRowsPerPage < allTecnicoCasos.length) {
                    tecnicoCurrentPage++;
                    renderTecnicoCasosPage();
                }
            });

            document.getElementById('incompat-search-input').addEventListener('input', () => {
                clearTimeout(filterTimeoutIncompat);
                filterTimeoutIncompat = setTimeout(applyTableFilters, 300);
            });
            document.getElementById('incompat-problem-filter-toggle').addEventListener('click', (e) => toggleDatePopup(e, 'incompat-problem-filter-popup'));
            document.getElementById('incompat-export-btn').addEventListener('click', exportIncompatibilidadeData);
            document.getElementById('ver-mais-tecnicos-btn').addEventListener('click', openAllTecnicosModal);

            fetchIncompatibilidadeData();

        } catch (error) {
            displayError("Erro ao inicializar o Dashboard de Incompatibilidades", error);
        }
    });
}

function updateIncompatDateRangeDisplay() {
    const startDate = new Date(document.getElementById('incompat-startDate').value.replace(/-/g, '/'));
    const endDate = new Date(document.getElementById('incompat-endDate').value.replace(/-/g, '/'));
    const options = { day: '2-digit', month: 'short', year: 'numeric' };
    const display = `${startDate.toLocaleDateString('pt-BR', options)} - ${endDate.toLocaleDateString('pt-BR', options)}`;
    document.getElementById('incompat-date-range-display').textContent = display;
}

function applyIncompatDateFilter() {
    document.getElementById('incompat-date-range-popup').classList.remove('show');
    updateIncompatDateRangeDisplay();
    pageCache.data.incompatibilidade = null; 
    fetchIncompatibilidadeData();
}

function fetchIncompatibilidadeData() {
    if (pageCache.data.incompatibilidade) {
        onIncompatibilidadeDataReceived(pageCache.data.incompatibilidade);
        return;
    }

    const loader = document.getElementById('incompat-loader');
    const content = document.getElementById('incompat-content');
    if (loader) loader.style.display = 'block';
    if (content) content.style.visibility = 'hidden';

    const dateRange = {
        start: document.getElementById('incompat-startDate').value,
        end: document.getElementById('incompat-endDate').value
    };

    google.script.run
        .withSuccessHandler(onIncompatibilidadeDataReceived)
        .withFailureHandler(error => displayError('Falha ao buscar dados de Incompatibilidades', error))
        .getIncompatibilidadeDataWithCache(dateRange);
}

function onIncompatibilidadeDataReceived(data) {
    if (data.error) {
        displayError('Erro ao processar dados de Incompatibilidades', { message: data.error });
        return;
    }
    pageCache.data.incompatibilidade = data;

    const loader = document.getElementById('incompat-loader');
    const content = document.getElementById('incompat-content');
    if (loader) loader.style.display = 'none';
    if (content) content.style.visibility = 'visible';

    document.getElementById('kpi-total-casos').textContent = data.kpis.totalIncompatibilidades || 0;
    document.getElementById('kpi-custo-total').textContent = (data.kpis.custoTotal || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('kpi-tempo-medio').textContent = `${(data.kpis.tempoMedioHoras || 0).toFixed(1)}h`;
    document.getElementById('kpi-tempo-medio-montagem').textContent = `${(data.kpis.tempoMedioMontagemGeral || 0).toFixed(2)}h`;

    renderTopTecnicosList(data.allTecnicosStats.slice(0, 5));
    renderTopListIncompat('top-problemas-container', data.topProblemas, '#ff6000');
    renderTopListIncompat('top-fabricantes-container', data.topFabricantes, '#16a34a');
    
    drawDailyProductionVsProblemsChart(data.dailyProductionVsProblems);

    allIncompatibilidadeRows = data.tabela || [];
    populateProblemFilter(data.uniqueProblemTypes);
    applyTableFilters();
}

function drawDailyProductionVsProblemsChart(chartData) {
    const chartDiv = document.getElementById('daily-production-problems-chart');
    if (!chartDiv) return;
    if (!chartData || chartData.length <= 1) {
        chartDiv.innerHTML = '<p class="text-center text-slate-500 pt-10">Dados insuficientes para gerar o gráfico no período.</p>';
        return;
    }

    const dataArray = [
        ['Dia', 'Máquinas Montadas', { role: 'annotation' }, 'Problemas', { role: 'annotation' }, { role: 'tooltip', type: 'string', p: { html: true } }]
    ];
    chartData.slice(1).forEach(([day, production, problems]) => {
        const tooltipHtml = `
            <div style="padding:10px; font-family: Inter, sans-serif; font-size: 12px; min-width: 150px;">
                <div style="font-weight: bold; margin-bottom: 5px;">${day}</div>
                <div style="display: flex; align-items: center; margin-top: 5px;"><span style="height: 10px; width: 10px; background-color: #00529e; border-radius: 50%; display: inline-block; margin-right: 8px;"></span><span><strong>${production}</strong> Máquinas Montadas</span></div>
                <div style="display: flex; align-items: center; margin-top: 5px;"><span style="height: 10px; width: 10px; background-color: #ff6000; border-radius: 50%; display: inline-block; margin-right: 8px;"></span><span><strong>${problems}</strong> Problemas</span></div>
            </div>`;
        dataArray.push([day, production, production > 0 ? production.toString() : '', problems, problems > 0 ? problems.toString() : '', tooltipHtml]);
    });
    
    const dataTable = google.visualization.arrayToDataTable(dataArray);
    const textStyle = { color: '#475569', fontName: 'Inter', fontSize: 12 };
    const options = {
        fontName: 'Inter',
        legend: { position: 'top', alignment: 'center', textStyle: textStyle },
        seriesType: 'bars',
        series: {
            0: { color: '#00529e', annotations: { textStyle: { color: '#1e293b', bold: true, auraColor: 'white' } } },
            1: { type: 'line', color: '#ff6000', lineWidth: 3, pointSize: 6, pointShape: 'circle', annotations: { textStyle: { color: '#ff6000', bold: true, auraColor: 'white' } } }
        },
        vAxis: {
            title: 'Quantidade', 
            format: '0', 
            textStyle: textStyle,
            titleTextStyle: { ...textStyle, color: '#1e293b', bold: true, italic: false },
            gridlines: { color: '#e2e8f0' }, 
            viewWindow: { min: 0 }
        },
        hAxis: { textStyle: textStyle, slantedText: chartData.length > 20, slantedTextAngle: 45 },
        backgroundColor: { fill: 'transparent' },
        chartArea: { left: 60, top: 50, width: '90%', height: '70%' },
        tooltip: { isHtml: true, trigger: 'focus' },
        animation: { startup: true, duration: 1000, easing: 'out' },
        annotations: { alwaysOutside: true, textStyle: { fontSize: 11 } }
    };

    const chart = new google.visualization.ComboChart(chartDiv);
    chart.draw(dataTable, options);
}


function populateProblemFilter(problemTypes) {
    const container = document.getElementById('incompat-problem-filter-options');
    if (!container) return;
    container.innerHTML = '';
    
    if (!problemTypes || problemTypes.length === 0) {
        container.innerHTML = '<p class="text-xs text-slate-400">Nenhum tipo encontrado.</p>';
        return;
    }

    problemTypes.forEach(problem => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        const problemId = 'problem-' + problem.replace(/[^a-zA-Z0-9]/g, '');
        div.innerHTML = `
            <input type="checkbox" id="${problemId}" value="${problem}" class="problem-filter-checkbox h-4 w-4 rounded border-slate-300 text-orange-600 focus:ring-orange-500">
            <label for="${problemId}" class="ml-2 text-sm text-slate-600">${problem}</label>
        `;
        container.appendChild(div);
    });

    document.querySelectorAll('.problem-filter-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', applyTableFilters);
    });
}

function applyTableFilters() {
    const searchTerm = document.getElementById('incompat-search-input').value.toLowerCase();
    
    const selectedProblems = [];
    document.querySelectorAll('.problem-filter-checkbox:checked').forEach(checkbox => {
        selectedProblems.push(checkbox.value);
    });

    filteredIncompatibilidadeRows = allIncompatibilidadeRows.filter(row => {
        const searchMatch = !searchTerm ||
            (row.tecnico && row.tecnico.toLowerCase().includes(searchTerm)) ||
            (row.pedido && String(row.pedido).toLowerCase().includes(searchTerm)) ||
            (row.os && String(row.os).toLowerCase().includes(searchTerm));
        
        const problemMatch = selectedProblems.length === 0 || selectedProblems.includes(row.tipoProblema);

        return searchMatch && problemMatch;
    });

    incompatCurrentPage = 1;
    renderIncompatibilidadeTablePage();
}

function renderTopTecnicosList(data) {
    const container = document.getElementById('top-tecnicos-container');
    if (!container) return;
    container.innerHTML = '';

    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-sm text-slate-500">Nenhum técnico encontrado.</p>';
        return;
    }

    const maxProblemas = Math.max(...data.map(d => d.problemas), 0);

    data.forEach(item => {
        const percentageProblemas = maxProblemas > 0 ? (item.problemas / maxProblemas) * 100 : 0;
        
        const listItem = `
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="font-medium text-slate-700 truncate cursor-pointer hover:text-orange-500" title="${item.tecnico}" onclick="openTecnicoModal('${item.tecnico.replace(/'/g, "\\'")}')">${item.tecnico}</span>
                    <div class="flex items-center">
                        <span class="font-bold text-red-600 mr-2" title="Taxa de Problemas">${item.porcentagem.toFixed(2)}%</span>
                        <span class="font-bold text-slate-800" title="Nº de Problemas">${item.problemas}</span>
                    </div>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-1.5">
                    <div class="bg-orange-500 h-1.5 rounded-full" style="width: ${percentageProblemas}%;"></div>
                </div>
            </div>`;
        container.innerHTML += listItem;
    });
}


function renderTopListIncompat(containerId, data, barColor) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-sm text-slate-500">Nenhum dado encontrado.</p>';
        return;
    }

    const maxCount = data.length > 0 ? data[0][1] : 0;

    data.forEach(([item, count]) => {
        const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
        const listItem = `
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="font-medium text-slate-700 truncate" title="${item}">${item}</span>
                    <span class="font-bold text-slate-800">${count}</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-1.5">
                    <div class="h-1.5 rounded-full" style="width: ${percentage}%; background-color: ${barColor};"></div>
                </div>
            </div>`;
        container.innerHTML += listItem;
    });
}


function renderIncompatibilidadeTablePage() {
    const tbody = document.getElementById('incompat-table-body');
    const pageInfo = document.getElementById('incompat-page-info');
    const prevBtn = document.getElementById('incompat-prev-page');
    const nextBtn = document.getElementById('incompat-next-page');

    if (!tbody) return;
    tbody.innerHTML = '';

    if (filteredIncompatibilidadeRows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Nenhum registro encontrado para os filtros aplicados.</td></tr>';
        pageInfo.textContent = '0 de 0';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
    }

    const startIndex = (incompatCurrentPage - 1) * incompatRowsPerPage;
    const endIndex = startIndex + incompatRowsPerPage;
    const pageRows = filteredIncompatibilidadeRows.slice(startIndex, endIndex);

    let tableHtml = '';
    pageRows.forEach(row => {
        const shortDetail = row.detalheProblema && row.detalheProblema.length > 70 
            ? row.detalheProblema.substring(0, 70) + '...' 
            : row.detalheProblema;

        const tecnicoHtml = `<span class="font-semibold cursor-pointer hover:text-orange-500" onclick="openTecnicoModal('${row.tecnico.replace(/'/g, "\\'")}')">${row.tecnico}</span>`;

        tableHtml += `
            <tr class="border-b hover:bg-orange-50 transition-colors">
                <td class="p-3">${row.data}</td>
                <td class="p-3">${tecnicoHtml}</td>
                <td class="p-3">${row.os}</td>
                <td class="p-3">${row.pedido}</td>
                <td class="p-3">${row.produto}</td>
                <td class="p-3">${row.tipoProblema}</td>
                <td class="p-3" title="${row.detalheProblema}">${shortDetail}</td>
            </tr>
        `;
    });
    tbody.innerHTML = tableHtml;
    
    pageInfo.textContent = `${startIndex + 1} - ${Math.min(endIndex, filteredIncompatibilidadeRows.length)} de ${filteredIncompatibilidadeRows.length}`;
    prevBtn.disabled = incompatCurrentPage === 1;
    nextBtn.disabled = endIndex >= filteredIncompatibilidadeRows.length;
}

// --- Funções do Modal 'Ver mais detalhes' ---

function openAllTecnicosModal() {
    const data = pageCache.data.incompatibilidade;
    if (!data || !data.allTecnicosStats) {
        alert("Os dados dos técnicos ainda não foram carregados.");
        return;
    }
    
    document.getElementById('modal-kpi-producao').textContent = data.kpis.totalProducao || 0;
    document.getElementById('modal-kpi-problemas').textContent = data.kpis.totalProblemas || 0;
    document.getElementById('modal-kpi-taxa').textContent = `${(data.kpis.taxaMediaProblemas || 0).toFixed(2)}%`;
    document.getElementById('modal-kpi-tipos').textContent = data.kpis.totalTiposDeProblema || 0;

    document.querySelectorAll('#all-tecnicos-modal .sort-btn').forEach(button => {
        button.onclick = () => {
            const sortBy = button.dataset.sort;
            sortAllTecnicosTable(sortBy);
        };
    });
    
    allTecnicosSortCol = 'producao';
    allTecnicosSortDir = 'desc';
    sortAllTecnicosTable();

    const modal = document.getElementById('all-tecnicos-modal');
    const modalContent = document.getElementById('all-tecnicos-modal-content');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        modalContent.classList.remove('scale-95');
    }, 10);
}

function closeAllTecnicosModal() {
    const modal = document.getElementById('all-tecnicos-modal');
    const modalContent = document.getElementById('all-tecnicos-modal-content');
    modal.classList.add('opacity-0');
    modalContent.classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }, 300);
}

function sortAllTecnicosTable(sortBy) {
    const data = pageCache.data.incompatibilidade;
    if (!data || !data.allTecnicosStats) return;

    if (sortBy === allTecnicosSortCol) {
        allTecnicosSortDir = allTecnicosSortDir === 'asc' ? 'desc' : 'asc';
    } else if (sortBy) {
        allTecnicosSortCol = sortBy;
        allTecnicosSortDir = (sortBy === 'tecnico') ? 'asc' : (sortBy === 'tempoMedioMontagem') ? 'asc' : 'desc';
    }

    const sortedData = [...data.allTecnicosStats].sort((a, b) => {
        const valA = a[allTecnicosSortCol];
        const valB = b[allTecnicosSortCol];
        const direction = allTecnicosSortDir === 'asc' ? 1 : -1;

        if (typeof valA === 'string') {
            return valA.localeCompare(valB) * direction;
        } else {
            return (valA - valB) * direction;
        }
    });

    renderAllTecnicosTableBody(sortedData);
    updateAllTecnicosSortIcons();
}

function renderAllTecnicosTableBody(data) {
    const tbody = document.getElementById('all-tecnicos-table-body');
    tbody.innerHTML = '';
    const kpis = pageCache.data.incompatibilidade.kpis;

    data.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-200';
        tr.innerHTML = `
            <td class="p-3">
                <span class="font-semibold text-slate-700 cursor-pointer hover:text-orange-500" onclick="openTecnicoModal('${item.tecnico.replace(/'/g, "\\'")}')">
                    ${item.tecnico}
                </span>
            </td>
            <td class="p-3 text-center">${item.producao}</td>
            <td class="p-3 text-center">${item.problemas}</td>
            <td class="p-3 text-center font-semibold ${item.porcentagem > kpis.taxaMediaProblemas ? 'text-red-600' : 'text-emerald-600'}">
                ${item.porcentagem.toFixed(2)}%
            </td>
            <td class="p-3 text-center">${(item.tempoMedioMontagem).toFixed(2)}h</td>
        `;
        tbody.appendChild(tr);
    });
}

function updateAllTecnicosSortIcons() {
    const iconAsc = `<svg class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>`;
    const iconDesc = `<svg class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>`;
    
    document.querySelectorAll('#all-tecnicos-modal .sort-btn').forEach(button => {
        const iconSpan = button.querySelector('.sort-icon');
        if (button.dataset.sort === allTecnicosSortCol) {
            iconSpan.innerHTML = allTecnicosSortDir === 'asc' ? iconAsc : iconDesc;
        } else {
            iconSpan.innerHTML = '';
        }
    });
}

// --- Funções do Modal do Técnico Individual ---

function openTecnicoModal(tecnicoNome) {
    const modal = document.getElementById('tecnico-modal');
    const modalContent = document.getElementById('tecnico-modal-content');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        modalContent.classList.remove('scale-95');
    }, 10);

    document.getElementById('tecnico-modal-title').textContent = `Mini Dashboard: ${tecnicoNome}`;
    document.getElementById('tecnico-loader').style.display = 'block';
    document.getElementById('tecnico-dashboard-content').classList.add('hidden');

    const dateRange = {
        start: document.getElementById('incompat-startDate').value,
        end: document.getElementById('incompat-endDate').value
    };

    google.script.run
        .withSuccessHandler(onTecnicoDataReceived)
        .withFailureHandler(error => {
            document.getElementById('tecnico-loader').innerHTML = `<p class="text-red-500">Erro ao carregar dados: ${error.message}</p>`;
        })
        .getIncompatibilidadeDataForTechnicianWithCache(dateRange, tecnicoNome);
}

function onTecnicoDataReceived(data) {
    if (data.error) {
         document.getElementById('tecnico-loader').innerHTML = `<p class="text-red-500">Erro: ${data.error}</p>`;
         return;
    }

    document.getElementById('tecnico-loader').style.display = 'none';
    document.getElementById('tecnico-dashboard-content').classList.remove('hidden');

    document.getElementById('tecnico-kpi-producao').textContent = data.producaoCustomiza || 0;
    document.getElementById('tecnico-kpi-total').textContent = data.totalCasos || 0;

    drawTecnicoProblemasChart(data.problemas);
    drawTecnicoFrequenciaChart('tecnico-mensal-chart', data.frequenciaMensal);
    drawTecnicoFrequenciaChart('tecnico-diaria-chart', data.frequenciaDiaria);
    
    allTecnicoCasos = data.casos || [];
    tecnicoCurrentPage = 1;
    renderTecnicoCasosPage();
}

function closeTecnicoModal() {
    const modal = document.getElementById('tecnico-modal');
    const modalContent = document.getElementById('tecnico-modal-content');
    modal.classList.add('opacity-0');
    modalContent.classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }, 300);
}

function drawTecnicoProblemasChart(chartData) {
    const chartDiv = document.getElementById('tecnico-problemas-chart');
    if (!chartData || chartData.length <= 1) {
        chartDiv.innerHTML = '<p class="text-center text-slate-500 pt-10">Nenhum problema registrado.</p>';
        return;
    }
    const data = google.visualization.arrayToDataTable(chartData);
    const options = {
        pieHole: 0.4,
        fontName: 'Inter',
        legend: { position: 'right', textStyle: { color: '#333', fontSize: 12 } },
        chartArea: { left: 10, top: 20, width: '95%', height: '85%' },
        colors: ['#00529e', '#ff6000', '#16a34a', '#f59e0b', '#6366f1']
    };
    const chart = new google.visualization.PieChart(chartDiv);
    chart.draw(data, options);
}

function drawTecnicoFrequenciaChart(elementId, chartData) {
    const chartDiv = document.getElementById(elementId);
    if (!chartData || chartData.length <= 1) {
        chartDiv.innerHTML = `<p class="text-center text-slate-500 pt-10">Dados insuficientes para gerar o gráfico.</p>`;
        return;
    }
    const data = google.visualization.arrayToDataTable(chartData);

    let chart;
    let options;

    const baseOptions = {
        fontName: 'Inter',
        legend: { position: 'none' },
        hAxis: { textStyle: { fontSize: 11, color: '#333' } },
        vAxis: { 
            title: 'Casos',
            minValue: 0, 
            gridlines: { color: '#e2e8f0' }, 
            format: '0',
            textStyle: { color: '#333' }
        },
        annotations: { 
            alwaysOutside: true, 
            textStyle: { 
                fontSize: 12, 
                color: '#1e293b', 
                auraColor: 'none' 
            } 
        },
        chartArea: { left: 50, top: 30, width: '90%', height: '75%' },
        colors: ['#00529e']
    };

    if (elementId === 'tecnico-diaria-chart') {
        const maxValue = chartData.slice(1).reduce((max, row) => Math.max(max, row[1]), 0);
        
        options = {
            ...baseOptions,
            vAxis: {
                ...baseOptions.vAxis,
                viewWindow: { min: 0, max: maxValue + 5 }
            },
            curveType: 'function',
            pointsVisible: true,
            pointSize: 5,
        };
        chart = new google.visualization.LineChart(chartDiv);
    } else {
        options = {
            ...baseOptions,
            bar: { groupWidth: '60%' },
        };
        chart = new google.visualization.ColumnChart(chartDiv);
    }

    const view = new google.visualization.DataView(data);
    view.setColumns([0, 1, { calc: "stringify", sourceColumn: 1, type: "string", role: "annotation" }]);
    
    chart.draw(view, options);
}

function renderTecnicoCasosPage() {
    const tbody = document.getElementById('tecnico-casos-table-body');
    const pageInfo = document.getElementById('tecnico-casos-page-info');
    const prevBtn = document.getElementById('tecnico-casos-prev-page');
    const nextBtn = document.getElementById('tecnico-casos-next-page');

    if (!tbody) return;
    tbody.innerHTML = '';

    if (allTecnicoCasos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Nenhum caso registrado para este técnico no período.</td></tr>';
        pageInfo.textContent = '0 de 0';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
    }

    const startIndex = (tecnicoCurrentPage - 1) * tecnicoRowsPerPage;
    const endIndex = startIndex + tecnicoRowsPerPage;
    const pageRows = allTecnicoCasos.slice(startIndex, endIndex);

    let tableHtml = '';
    pageRows.forEach(row => {
        const shortDetail = row.detalheProblema && row.detalheProblema.length > 50 
            ? row.detalheProblema.substring(0, 50) + '...' 
            : row.detalheProblema;

        tableHtml += `
            <tr class="border-b border-slate-200">
                <td class="p-3">${row.data}</td>
                <td class="p-3">${row.os}</td>
                <td class="p-3">${row.pedido}</td>
                <td class="p-3">${row.produto}</td>
                <td class="p-3">${row.tipoProblema}</td>
                <td class="p-3" title="${row.detalheProblema}">${shortDetail}</td>
            </tr>
        `;
    });
    tbody.innerHTML = tableHtml;
    
    pageInfo.textContent = `${startIndex + 1} - ${Math.min(endIndex, allTecnicoCasos.length)} de ${allTecnicoCasos.length}`;
    prevBtn.disabled = tecnicoCurrentPage === 1;
    nextBtn.disabled = endIndex >= allTecnicoCasos.length;
}


function exportIncompatibilidadeData() {
    if (filteredIncompatibilidadeRows.length === 0) {
        alert('Não há dados para exportar com os filtros atuais.');
        return;
    }

    const headers = ['Data', 'Técnico', 'OS', 'Pedido', 'Produto', 'Tipo de Problema', 'Detalhe do Problema'];
    
    const dataToExport = filteredIncompatibilidadeRows.map(row => [
        row.data,
        row.tecnico,
        row.os,
        row.pedido,
        row.produto,
        row.tipoProblema,
        row.detalheProblema
    ]);

    const csvRows = [headers, ...dataToExport];
    const startDate = document.getElementById('incompat-startDate').value;
    const endDate = document.getElementById('incompat-endDate').value;
    
    exportToCsvIncompat(`incompatibilidades_${startDate}_a_${endDate}.csv`, csvRows);
}

function exportToCsvIncompat(filename, rows) {
    const processRow = (row) => {
        return row.map(val => {
            let innerValue = val === null || val === undefined ? '' : String(val);
            let result = innerValue.replace(/"/g, '""');
            if (result.search(/("|,|\n)/g) >= 0) { 
                result = '"' + result + '"'; 
            }
            return result;
        }).join(';');
    };

    const csvContent = rows.map(processRow).join('\n');
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");

    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}
</script>

