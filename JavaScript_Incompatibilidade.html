<script>
// ==================================================================
// === LÓGICA DA PÁGINA DE INCOMPATIBILIDADES =======================
// ==================================================================

// Variáveis globais para a tabela principal
let allIncompatibilidadeRows = [];
let incompatCurrentPage = 1;
const incompatRowsPerPage = 20;

// Variáveis globais para a tabela do modal do técnico
let allTecnicoCasos = [];
let tecnicoCurrentPage = 1;
const tecnicoRowsPerPage = 10;

function initializeIncompatibilidadePage() {
    try {
        const today = new Date();
        const firstDayMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('incompat-endDate').value = today.toISOString().split('T')[0];
        document.getElementById('incompat-startDate').value = firstDayMonth.toISOString().split('T')[0];
        
        document.getElementById('incompat-applyButton').addEventListener('click', applyIncompatDateFilter);
        document.getElementById('incompat-date-range-toggle').addEventListener('click', (e) => toggleDatePopup(e, 'incompat-date-range-popup'));
        document.getElementById('incompat-cancelButton').addEventListener('click', (e) => toggleDatePopup(e, 'incompat-date-range-popup'));
        updateIncompatDateRangeDisplay();
        
        document.getElementById('incompat-prev-page').addEventListener('click', () => {
            if (incompatCurrentPage > 1) {
                incompatCurrentPage--;
                renderIncompatibilidadeTablePage();
            }
        });
        document.getElementById('incompat-next-page').addEventListener('click', () => {
            if (incompatCurrentPage * incompatRowsPerPage < allIncompatibilidadeRows.length) {
                incompatCurrentPage++;
                renderIncompatibilidadeTablePage();
            }
        });

        // Adiciona event listeners para a paginação do modal
        document.getElementById('tecnico-casos-prev-page').addEventListener('click', () => {
            if (tecnicoCurrentPage > 1) {
                tecnicoCurrentPage--;
                renderTecnicoCasosPage();
            }
        });
        document.getElementById('tecnico-casos-next-page').addEventListener('click', () => {
            if (tecnicoCurrentPage * tecnicoRowsPerPage < allTecnicoCasos.length) {
                tecnicoCurrentPage++;
                renderTecnicoCasosPage();
            }
        });

        fetchIncompatibilidadeData();

    } catch (error) {
        displayError("Erro ao inicializar o Dashboard de Incompatibilidades", error);
    }
}

function updateIncompatDateRangeDisplay() {
    const startDate = new Date(document.getElementById('incompat-startDate').value.replace(/-/g, '/'));
    const endDate = new Date(document.getElementById('incompat-endDate').value.replace(/-/g, '/'));
    const options = { day: '2-digit', month: 'short', year: 'numeric' };
    const display = `${startDate.toLocaleDateString('pt-BR', options)} - ${endDate.toLocaleDateString('pt-BR', options)}`;
    document.getElementById('incompat-date-range-display').textContent = display;
}

function applyIncompatDateFilter() {
    document.getElementById('incompat-date-range-popup').classList.remove('show');
    updateIncompatDateRangeDisplay();
    pageCache.data.incompatibilidade = null; 
    fetchIncompatibilidadeData();
}

function fetchIncompatibilidadeData() {
    if (pageCache.data.incompatibilidade) {
        onIncompatibilidadeDataReceived(pageCache.data.incompatibilidade);
        return;
    }

    const loader = document.getElementById('incompat-loader');
    const content = document.getElementById('incompat-content');
    if (loader) loader.style.display = 'block';
    if (content) content.style.visibility = 'hidden';

    const dateRange = {
        start: document.getElementById('incompat-startDate').value,
        end: document.getElementById('incompat-endDate').value
    };

    google.script.run
        .withSuccessHandler(onIncompatibilidadeDataReceived)
        .withFailureHandler(error => displayError('Falha ao buscar dados de Incompatibilidades', error))
        .getIncompatibilidadeDataWithCache(dateRange);
}

function onIncompatibilidadeDataReceived(data) {
    if (data.error) {
        displayError('Erro ao processar dados de Incompatibilidades', { message: data.error });
        return;
    }
    pageCache.data.incompatibilidade = data;

    const loader = document.getElementById('incompat-loader');
    const content = document.getElementById('incompat-content');
    if (loader) loader.style.display = 'none';
    if (content) content.style.visibility = 'visible';

    // Atualiza KPIs
    document.getElementById('kpi-total-casos').textContent = data.kpis.totalIncompatibilidades || 0;
    document.getElementById('kpi-custo-total').textContent = (data.kpis.custoTotal || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('kpi-tempo-medio').textContent = `${(data.kpis.tempoMedioHoras || 0).toFixed(1)}h`;

    // Renderiza listas
    renderTopListIncompat('top-tecnicos-container', data.topTecnicos, '#00529e');
    renderTopListIncompat('top-problemas-container', data.topProblemas, '#ff6000');
    renderTopListIncompat('top-fabricantes-container', data.topFabricantes, '#16a34a');

    // Prepara e renderiza a tabela detalhada
    allIncompatibilidadeRows = data.tabela || [];
    incompatCurrentPage = 1;
    renderIncompatibilidadeTablePage();
}

function renderTopListIncompat(containerId, data, barColor) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-sm text-slate-500">Nenhum dado encontrado.</p>';
        return;
    }

    const maxCount = data[0][1];

    data.forEach(([item, count]) => {
        const percentage = (count / maxCount) * 100;
        
        const listItem = `
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="font-medium text-slate-700 truncate" title="${item}">${item}</span>
                    <span class="font-bold text-slate-800">${count}</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-1.5">
                    <div class="h-1.5 rounded-full" style="width: ${percentage}%; background-color: ${barColor};"></div>
                </div>
            </div>
        `;
        container.innerHTML += listItem;
    });
}

function renderIncompatibilidadeTablePage() {
    const tbody = document.getElementById('incompat-table-body');
    const pageInfo = document.getElementById('incompat-page-info');
    const prevBtn = document.getElementById('incompat-prev-page');
    const nextBtn = document.getElementById('incompat-next-page');

    if (!tbody) return;
    tbody.innerHTML = '';

    if (allIncompatibilidadeRows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Nenhum registro encontrado para o período.</td></tr>';
        pageInfo.textContent = '0 de 0';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
    }

    const startIndex = (incompatCurrentPage - 1) * incompatRowsPerPage;
    const endIndex = startIndex + incompatRowsPerPage;
    const pageRows = allIncompatibilidadeRows.slice(startIndex, endIndex);

    let tableHtml = '';
    pageRows.forEach(row => {
        const shortDetail = row.detalheProblema && row.detalheProblema.length > 70 
            ? row.detalheProblema.substring(0, 70) + '...' 
            : row.detalheProblema;

        const tecnicoHtml = `<span class="font-semibold cursor-pointer hover:text-orange-500" onclick="openTecnicoModal('${row.tecnico.replace(/'/g, "\\'")}')">${row.tecnico}</span>`;

        tableHtml += `
            <tr class="border-b hover:bg-orange-50 transition-colors">
                <td class="p-3">${row.data}</td>
                <td class="p-3">${tecnicoHtml}</td>
                <td class="p-3">${row.os}</td>
                <td class="p-3">${row.pedido}</td>
                <td class="p-3">${row.produto}</td>
                <td class="p-3">${row.tipoProblema}</td>
                <td class="p-3" title="${row.detalheProblema}">${shortDetail}</td>
            </tr>
        `;
    });
    tbody.innerHTML = tableHtml;
    
    pageInfo.textContent = `${startIndex + 1} - ${Math.min(endIndex, allIncompatibilidadeRows.length)} de ${allIncompatibilidadeRows.length}`;
    prevBtn.disabled = incompatCurrentPage === 1;
    nextBtn.disabled = endIndex >= allIncompatibilidadeRows.length;
}

// --- Funções do Modal do Técnico ---

function openTecnicoModal(tecnicoNome) {
    const modal = document.getElementById('tecnico-modal');
    const modalContent = document.getElementById('tecnico-modal-content');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        modalContent.classList.remove('scale-95');
    }, 10);

    document.getElementById('tecnico-modal-title').textContent = `Mini Dashboard: ${tecnicoNome}`;
    document.getElementById('tecnico-loader').style.display = 'block';
    document.getElementById('tecnico-dashboard-content').classList.add('hidden');

    const dateRange = {
        start: document.getElementById('incompat-startDate').value,
        end: document.getElementById('incompat-endDate').value
    };

    google.script.run
        .withSuccessHandler(onTecnicoDataReceived)
        .withFailureHandler(error => {
            document.getElementById('tecnico-loader').innerHTML = `<p class="text-red-500">Erro ao carregar dados: ${error.message}</p>`;
        })
        .getIncompatibilidadeDataForTechnicianWithCache(dateRange, tecnicoNome);
}

function onTecnicoDataReceived(data) {
    if (data.error) {
         document.getElementById('tecnico-loader').innerHTML = `<p class="text-red-500">Erro: ${data.error}</p>`;
         return;
    }

    document.getElementById('tecnico-loader').style.display = 'none';
    document.getElementById('tecnico-dashboard-content').classList.remove('hidden');

    document.getElementById('tecnico-kpi-total').textContent = data.totalCasos || 0;

    drawTecnicoProblemasChart(data.problemas);
    drawTecnicoFrequenciaChart('tecnico-mensal-chart', data.frequenciaMensal);
    drawTecnicoFrequenciaChart('tecnico-diaria-chart', data.frequenciaDiaria);
    
    allTecnicoCasos = data.casos || [];
    tecnicoCurrentPage = 1;
    renderTecnicoCasosPage();
}

function closeTecnicoModal() {
    const modal = document.getElementById('tecnico-modal');
    const modalContent = document.getElementById('tecnico-modal-content');
    modal.classList.add('opacity-0');
    modalContent.classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }, 300);
}

function drawTecnicoProblemasChart(chartData) {
    const chartDiv = document.getElementById('tecnico-problemas-chart');
    if (!chartData || chartData.length <= 1) {
        chartDiv.innerHTML = '<p class="text-center text-slate-500 pt-10">Nenhum problema registrado.</p>';
        return;
    }
    const data = google.visualization.arrayToDataTable(chartData);
    const options = {
        pieHole: 0.4,
        fontName: 'Inter',
        legend: { position: 'right', textStyle: { color: '#333', fontSize: 12 } },
        chartArea: { left: 10, top: 20, width: '95%', height: '85%' },
        colors: ['#00529e', '#ff6000', '#16a34a', '#f59e0b', '#6366f1']
    };
    const chart = new google.visualization.PieChart(chartDiv);
    chart.draw(data, options);
}

function drawTecnicoFrequenciaChart(elementId, chartData) {
    const chartDiv = document.getElementById(elementId);
    if (!chartData || chartData.length <= 1) {
        chartDiv.innerHTML = `<p class="text-center text-slate-500 pt-10">Dados insuficientes para gerar o gráfico.</p>`;
        return;
    }
    const data = google.visualization.arrayToDataTable(chartData);

    let chart;
    let options;

    const baseOptions = {
        fontName: 'Inter',
        legend: { position: 'none' },
        hAxis: { textStyle: { fontSize: 11, color: '#333' } },
        vAxis: { 
            title: 'Casos',
            minValue: 0, 
            gridlines: { color: '#e2e8f0' }, 
            format: '0',
            textStyle: { color: '#333' }
        },
        annotations: { 
            alwaysOutside: true, 
            textStyle: { 
                fontSize: 12, 
                color: '#1e293b', 
                auraColor: 'none' 
            } 
        },
        chartArea: { left: 50, top: 30, width: '90%', height: '75%' },
        colors: ['#00529e']
    };

    if (elementId === 'tecnico-diaria-chart') {
        const maxValue = chartData.slice(1).reduce((max, row) => Math.max(max, row[1]), 0);
        
        options = {
            ...baseOptions,
            vAxis: {
                ...baseOptions.vAxis,
                viewWindow: { min: 0, max: maxValue + 5 }
            },
            curveType: 'function',
            pointsVisible: true,
            pointSize: 5,
        };
        chart = new google.visualization.LineChart(chartDiv);
    } else {
        options = {
            ...baseOptions,
            bar: { groupWidth: '60%' },
        };
        chart = new google.visualization.ColumnChart(chartDiv);
    }

    const view = new google.visualization.DataView(data);
    view.setColumns([0, 1, { calc: "stringify", sourceColumn: 1, type: "string", role: "annotation" }]);
    
    chart.draw(view, options);
}

function renderTecnicoCasosPage() {
    const tbody = document.getElementById('tecnico-casos-table-body');
    const pageInfo = document.getElementById('tecnico-casos-page-info');
    const prevBtn = document.getElementById('tecnico-casos-prev-page');
    const nextBtn = document.getElementById('tecnico-casos-next-page');

    if (!tbody) return;
    tbody.innerHTML = '';

    if (allTecnicoCasos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Nenhum caso registrado para este técnico no período.</td></tr>';
        pageInfo.textContent = '0 de 0';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
    }

    const startIndex = (tecnicoCurrentPage - 1) * tecnicoRowsPerPage;
    const endIndex = startIndex + tecnicoRowsPerPage;
    const pageRows = allTecnicoCasos.slice(startIndex, endIndex);

    let tableHtml = '';
    pageRows.forEach(row => {
        const shortDetail = row.detalheProblema && row.detalheProblema.length > 50 
            ? row.detalheProblema.substring(0, 50) + '...' 
            : row.detalheProblema;

        tableHtml += `
            <tr class="border-b border-slate-200">
                <td class="p-3">${row.data}</td>
                <td class="p-3">${row.os}</td>
                <td class="p-3">${row.pedido}</td>
                <td class="p-3">${row.produto}</td>
                <td class="p-3">${row.tipoProblema}</td>
                <td class="p-3" title="${row.detalheProblema}">${shortDetail}</td>
            </tr>
        `;
    });
    tbody.innerHTML = tableHtml;
    
    pageInfo.textContent = `${startIndex + 1} - ${Math.min(endIndex, allTecnicoCasos.length)} de ${allTecnicoCasos.length}`;
    prevBtn.disabled = tecnicoCurrentPage === 1;
    nextBtn.disabled = endIndex >= allTecnicoCasos.length;
}

</script>

