<script>
// ==================================================================
// === LÓGICA DA PÁGINA DE AUDITORIA ===============================
// @version 1.1 - Removidos KPIs e gráficos de NC por tipo (HW/SW)
// ==================================================================

let allAuditoriaRows = [];
let filteredAuditoriaRows = [];
let auditoriaCurrentPage = 1;
const auditoriaRowsPerPage = 20;
let filterTimeoutAuditoria;

function initializeAuditoriaPage() {
    google.charts.load('current', { 'packages': ['corechart', 'bar'] });
    google.charts.setOnLoadCallback(() => {
        try {
            const today = new Date();
            const firstDayMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('auditoria-endDate').value = today.toISOString().split('T')[0];
            document.getElementById('auditoria-startDate').value = firstDayMonth.toISOString().split('T')[0];
            
            document.getElementById('auditoria-applyButton').addEventListener('click', applyAuditoriaDateFilter);
            document.getElementById('auditoria-date-range-toggle').addEventListener('click', (e) => toggleDatePopup(e, 'auditoria-date-range-popup'));
            document.getElementById('auditoria-cancelButton').addEventListener('click', (e) => toggleDatePopup(e, 'auditoria-date-range-popup'));
            updateAuditoriaDateRangeDisplay();
            
            document.getElementById('auditoria-prev-page').addEventListener('click', () => {
                if (auditoriaCurrentPage > 1) {
                    auditoriaCurrentPage--;
                    renderAuditoriaTablePage();
                }
            });
            document.getElementById('auditoria-next-page').addEventListener('click', () => {
                if (auditoriaCurrentPage * auditoriaRowsPerPage < filteredAuditoriaRows.length) {
                    auditoriaCurrentPage++;
                    renderAuditoriaTablePage();
                }
            });

            document.getElementById('auditoria-search-input').addEventListener('input', () => {
                clearTimeout(filterTimeoutAuditoria);
                filterTimeoutAuditoria = setTimeout(applyAuditoriaTableFilters, 300);
            });
            
            fetchAuditoriaData();

        } catch (error) {
            displayError("Erro ao inicializar a página de Auditoria", error);
        }
    });
}

function updateAuditoriaDateRangeDisplay() {
    const startDate = new Date(document.getElementById('auditoria-startDate').value.replace(/-/g, '/'));
    const endDate = new Date(document.getElementById('auditoria-endDate').value.replace(/-/g, '/'));
    const options = { day: '2-digit', month: 'short', year: 'numeric' };
    const display = `${startDate.toLocaleDateString('pt-BR', options)} - ${endDate.toLocaleDateString('pt-BR', options)}`;
    document.getElementById('auditoria-date-range-display').textContent = display;
}

function applyAuditoriaDateFilter() {
    document.getElementById('auditoria-date-range-popup').classList.remove('show');
    updateAuditoriaDateRangeDisplay();
    pageCache.data.auditoria = null; 
    fetchAuditoriaData();
}

function fetchAuditoriaData() {
    if (pageCache.data.auditoria) {
        onAuditoriaDataReceived(pageCache.data.auditoria);
        return;
    }

    const loader = document.getElementById('auditoria-loader');
    const content = document.getElementById('auditoria-content');
    if (loader) loader.style.display = 'block';
    if (content) content.style.visibility = 'hidden';

    const dateRange = {
        start: document.getElementById('auditoria-startDate').value,
        end: document.getElementById('auditoria-endDate').value
    };

    google.script.run
        .withSuccessHandler(onAuditoriaDataReceived)
        .withFailureHandler(error => displayError('Falha ao buscar dados de Auditoria', error))
        .getAuditoriaDataWithCache(dateRange);
}

function onAuditoriaDataReceived(data) {
    if (data.error) {
        displayError('Erro ao processar dados de Auditoria', { message: data.error });
        return;
    }
    pageCache.data.auditoria = data;

    const loader = document.getElementById('auditoria-loader');
    const content = document.getElementById('auditoria-content');
    if (loader) loader.style.display = 'none';
    if (content) content.style.visibility = 'visible';
    
    // KPIs Atualizados
    document.getElementById('kpi-total-auditorias').textContent = data.kpis.totalAuditorias || 0;
    document.getElementById('kpi-taxa-conformidade').textContent = `${(data.kpis.taxaConformidade || 0).toFixed(1)}%`;
    document.getElementById('kpi-total-nc').textContent = data.kpis.totalNaoConformidades || 0; // Este KPI agora usa a contagem de auditorias com NC
    // Linhas dos KPIs removidos comentadas/removidas
    // document.getElementById('kpi-nc-hardware').textContent = data.kpis.totalNcHardware || 0;
    // document.getElementById('kpi-nc-software').textContent = data.kpis.totalNcSoftware || 0;

    // Gráficos Removidos
    // drawHorizontalBarChart('nc-hardware-chart', [['Categoria', 'Ocorrências'], ...data.charts.topNcHardware], '#f97316');
    // drawHorizontalBarChart('nc-software-chart', [['Categoria', 'Ocorrências'], ...data.charts.topNcSoftware], '#3b82f6');

    // Performance Auditores (Mantido)
    renderAuditorsPerformance(data.charts.performanceAuditores);

    // Tabela (Mantida)
    allAuditoriaRows = data.tabela || [];
    applyAuditoriaTableFilters();
}

// Função drawHorizontalBarChart removida, pois não é mais utilizada para NCs
/*
function drawHorizontalBarChart(elementId, chartData, color) {
    // ... código antigo ...
}
*/

function renderAuditorsPerformance(performanceData) {
    const container = document.getElementById('performance-auditores-container');
    if (!container) return;
    container.innerHTML = '';

    if (!performanceData || performanceData.length === 0) {
        container.innerHTML = '<p class="text-sm text-slate-500 text-center">Nenhum auditor encontrado no período.</p>';
        return;
    }

    performanceData.forEach(auditor => {
        const taxaNcColor = auditor.taxaNC > 10 ? 'text-red-600' : 'text-emerald-600'; // Exemplo: >10% é vermelho
        const itemHtml = `
            <div class="grid grid-cols-5 items-center gap-4 text-sm">
                <span class="col-span-2 font-medium text-slate-700">${auditor.nome}</span>
                <div class="col-span-3">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-slate-500">Auditadas: <strong class="text-slate-800">${auditor.auditadas}</strong></span>
                        <span class="text-slate-500">Com NC: <strong class="text-red-600">${auditor.comNC}</strong></span>
                        <span class="font-bold ${taxaNcColor}">${auditor.taxaNC.toFixed(1)}%</span>
                    </div>
                    <!-- Barra de progresso pode ser mantida ou removida, dependendo da preferência visual -->
                    <div class="w-full bg-slate-200 rounded-full h-2">
                        <div class="bg-gradient-to-r from-emerald-500 to-red-500 h-2 rounded-full" style="width: ${auditor.taxaNC}%;"></div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += itemHtml;
    });
}


function applyAuditoriaTableFilters() {
    const searchTerm = document.getElementById('auditoria-search-input').value.toLowerCase();
    
    filteredAuditoriaRows = allAuditoriaRows.filter(row => {
        // Verifica se searchTerm existe (não é nulo ou vazio) antes de aplicar filtros
        const hasSearchTerm = searchTerm && searchTerm.length > 0;
        
        // Se não houver termo de busca, retorna true (inclui a linha)
        if (!hasSearchTerm) {
            return true;
        }

        // Se houver termo de busca, verifica se ele está presente em algum dos campos
        return (row.os && String(row.os).toLowerCase().includes(searchTerm)) ||
               (row.auditor && row.auditor.toLowerCase().includes(searchTerm)) ||
               (row.tecMontagem && row.tecMontagem.toLowerCase().includes(searchTerm)) ||
               (row.tecQualidade && row.tecQualidade.toLowerCase().includes(searchTerm));
    });

    auditoriaCurrentPage = 1;
    renderAuditoriaTablePage();
}


function renderAuditoriaTablePage() {
    const tbody = document.getElementById('auditoria-table-body');
    const pageInfo = document.getElementById('auditoria-page-info');
    const prevBtn = document.getElementById('auditoria-prev-page');
    const nextBtn = document.getElementById('auditoria-next-page');

    if (!tbody) return;
    tbody.innerHTML = '';

    if (filteredAuditoriaRows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4">Nenhum registro encontrado para os filtros aplicados.</td></tr>'; // Colspan ajustado para 8
        pageInfo.textContent = '0 de 0';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
    }

    const startIndex = (auditoriaCurrentPage - 1) * auditoriaRowsPerPage;
    const endIndex = startIndex + auditoriaRowsPerPage;
    const pageRows = filteredAuditoriaRows.slice(startIndex, endIndex);

    let tableHtml = '';
    pageRows.forEach(row => {
        const statusClass = row.status === 'Conforme' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const shortDesc = row.ncDescricao && row.ncDescricao.length > 50 ? row.ncDescricao.substring(0, 50) + '...' : row.ncDescricao;
        const shortItens = row.ncItens && row.ncItens.length > 50 ? row.ncItens.substring(0, 50) + '...' : row.ncItens;
        
        tableHtml += `
            <tr class="border-b hover:bg-slate-50 transition-colors">
                <td class="p-3">${row.data}</td>
                <td class="p-3">${row.os || 'N/A'}</td>
                <td class="p-3">${row.auditor}</td>
                <td class="p-3">${row.tecMontagem}</td>
                <td class="p-3">${row.tecQualidade}</td>
                <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${row.status}</span></td>
                <td class="p-3" title="${row.ncItens}">${shortItens}</td> 
                <td class="p-3" title="${row.ncDescricao}">${shortDesc}</td>
            </tr>
        `;
    });
    tbody.innerHTML = tableHtml;
    
    pageInfo.textContent = `${startIndex + 1} - ${Math.min(endIndex, filteredAuditoriaRows.length)} de ${filteredAuditoriaRows.length}`;
    prevBtn.disabled = auditoriaCurrentPage === 1;
    nextBtn.disabled = endIndex >= filteredAuditoriaRows.length;
}
</script>

