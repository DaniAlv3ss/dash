<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Dashboard KaBuM! - Monte o Seu PC</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos para a transição suave do menu e conteúdo */
        #main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-closed {
            transform: translateX(-100%);
        }
        /* Estilos legados para popups e gráficos */
        .date-popup { display: none; position: absolute; right: 0; top: calc(100% + 5px); background-color: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 100; padding: 20px; width: max-content; }
        .date-popup.show { display: block; }
        .date-inputs { display: flex; gap: 20px; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; }
        .date-inputs div { display: flex; flex-direction: column; }
        .date-inputs label { font-size: 0.9em; margin-bottom: 5px; color: #555; font-weight: bold; }
        .date-inputs input { border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-size: 1em; }
        .popup-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .popup-actions button { padding: 8px 16px; font-size: 0.9em; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; }
        .cancel-button { background-color: #f0f0f0; border: 1px solid #ccc; }
        .apply-button { background-color: #00529e; color: white; }
        .arc-gauge-container { position: relative; width: 250px; height: 125px; display: flex; justify-content: center; align-items: center; margin-top: 20px; }
        .arc-gauge-value { position: absolute; bottom: 5px; font-size: 2.8em; font-weight: bold; }
        .arc-gauge-svg { width: 100%; height: 100%; }
        .arc-gauge-track, .arc-gauge-fill { fill: none; stroke-width: 18; stroke-linecap: butt; }
        .arc-gauge-track { stroke: #e6e6e6; }
        .arc-gauge-fill { transition: stroke-dashoffset 0.8s ease-out, stroke 0.5s ease-out; }
        .table-wrapper { max-height: 550px; overflow-y: auto; }
        .modal-table-wrapper { max-height: 60vh; overflow-y: auto; }
        .ai-tab.active { border-color: #22d3ee; color: #22d3ee; }
        .ai-tab-content { display: none; }
        .ai-tab-content.active { display: block; }

        /* --- INÍCIO: ANIMAÇÃO DA TIMELINE --- */
        @keyframes fade-slide-in {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .timeline-card-animated {
            animation: fade-slide-in 0.5s ease-out forwards;
            opacity: 0;
        }
        /* --- FIM: ANIMAÇÃO DA TIMELINE --- */
    </style>
</head>
<body class="bg-slate-100">

    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-slate-800 text-white z-30 shadow-lg flex flex-col">
        <div class="p-4 flex items-center justify-between border-b border-slate-700">
            <h1 class="text-xl font-bold text-white">Dashboards</h1>
        </div>
        <nav class="mt-4 flex-grow">
            <a href="#" onclick="event.preventDefault(); loadPage('Dashboard', this)" class="nav-link flex items-center py-3 px-4 text-slate-300 hover:bg-slate-700 hover:text-white rounded-md mx-2 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                <span>NPS</span>
            </a>
            <a href="#" onclick="event.preventDefault(); loadPage('Calltech', this)" class="nav-link flex items-center py-3 px-4 text-slate-300 hover:bg-slate-700 hover:text-white rounded-md mx-2 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>Calltech</span>
            </a>
            <!-- --- INÍCIO DA MODIFICAÇÃO --- -->
            <a href="#" onclick="event.preventDefault(); loadPage('Devolucao', this)" class="nav-link flex items-center py-3 px-4 text-slate-300 hover:bg-slate-700 hover:text-white rounded-md mx-2 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span>Devolução</span>
            </a>
            <!-- --- FIM DA MODIFICAÇÃO --- -->
        </nav>
    </div>

    <div id="main-content" class="ml-64">
        <header class="bg-white shadow-sm p-4 flex items-center sticky top-0 z-20">
            <button id="menu-toggle" class="text-slate-600 hover:text-slate-900">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <h2 id="page-title" class="text-xl font-semibold text-slate-800 ml-4"></h2>
        </header>

        <main id="page-content" class="p-4 md:p-6">
            <div id="page-loader" class="text-center py-20">
                <p class="text-lg font-semibold text-orange-500">Carregando...</p>
            </div>
        </main>
    </div>

    <script>
        // ==================================================================
        // === LÓGICA DE NAVEGAÇÃO E INICIALIZAÇÃO ==========================
        // ==================================================================
        
        const pageCache = {
            html: {},
            data: {}
        };

        document.addEventListener('DOMContentLoaded', () => {
            try {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('main-content');
                const menuToggle = document.getElementById('menu-toggle');

                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('sidebar-closed');
                    mainContent.style.marginLeft = sidebar.classList.contains('sidebar-closed') ? '0' : '16rem';
                });

                // Carrega a página inicial
                loadPage('Dashboard', document.querySelector('.nav-link'));

            } catch (error) {
                displayError('Erro Crítico na Inicialização', error);
            }
        });

        function loadPage(pageName, clickedLink) {
            const pageTitles = {
                'Dashboard': 'Dashboard de NPS - Monte o Seu PC',
                'Calltech': 'Dashboard de Atendimento - Calltech',
                // --- INÍCIO DA MODIFICAÇÃO ---
                'Devolucao': 'Dashboard de Devoluções - Monte o Seu PC'
                // --- FIM DA MODIFICAÇÃO ---
            };
            document.getElementById('page-title').textContent = pageTitles[pageName] || 'Dashboard';
            
            // Atualiza o estado ativo do menu
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('bg-slate-700', 'text-white'));
            if(clickedLink) clickedLink.classList.add('bg-slate-700', 'text-white');

            // Verifica se o HTML da página já está em cache
            if (pageCache.html[pageName]) {
                document.getElementById('page-content').innerHTML = pageCache.html[pageName];
                initializePage(pageName);
            } else {
                showPageLoader(`Carregando página ${pageName}...`);
                google.script.run
                    .withSuccessHandler(html => {
                        pageCache.html[pageName] = html;
                        document.getElementById('page-content').innerHTML = html;
                        initializePage(pageName);
                    })
                    .withFailureHandler(error => {
                        displayError(`Falha ao Carregar a Página "${pageName}"`, error);
                    })
                    .getPageHtml(pageName);
            }
        }
        
        // Direciona para a função de inicialização correta
        function initializePage(pageName) {
            if (pageName === 'Dashboard') {
                initializeDashboardPage();
            } else if (pageName === 'Calltech') {
                initializeCalltechPage();
            // --- INÍCIO DA MODIFICAÇÃO ---
            } else if (pageName === 'Devolucao') {
                initializeDevolucaoPage();
            }
            // --- FIM DA MODIFICAÇÃO ---
        }

        // ==================================================================
        // === FUNÇÕES UTILITÁRIAS GLOBAIS ==================================
        // ==================================================================

        // MODIFICADO: Função showPageLoader para usar apenas texto
        function showPageLoader(message = 'Carregando...') {
            document.getElementById('page-content').innerHTML = `
                <div id="page-loader" class="text-center py-20">
                    <p class="text-lg font-semibold text-orange-500">${message}</p>
                </div>`;
        }
        
        function displayError(title, error) {
            const errorMessage = error.message || JSON.stringify(error);
            const errorStack = error.stack || 'Não disponível';
             document.getElementById('page-content').innerHTML = 
                `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 m-4" role="alert">
                    <p class="font-bold">${title}</p>
                    <p>${errorMessage}</p>
                    <pre class="mt-2 text-xs">${errorStack}</pre>
                </div>`;
            console.error(title, error);
        }

        function toggleDatePopup(event, popupId) {
            event.stopPropagation();
            document.getElementById(popupId).classList.toggle('show');
        }

        // Fecha popups de data se clicar fora deles
        window.addEventListener('click', function(event) {
            document.querySelectorAll('.date-popup.show').forEach(popup => {
                const toggle = document.getElementById(popup.id.replace('popup', 'toggle'));
                if (toggle && !popup.contains(event.target) && !toggle.contains(event.target)) {
                    popup.classList.remove('show');
                }
            });
        });

    </script>
    
    <?!= include('JavaScript_Dashboard'); ?>
    <?!= include('JavaScript_Calltech'); ?>
    <!-- --- INÍCIO DA MODIFICAÇÃO --- -->
    <?!= include('JavaScript_Devolucao'); ?>
    <!-- --- FIM DA MODIFICAÇÃO --- -->

</body>
</html>
