<script>
// ==================================================================
// === LÓGICA DA PÁGINA DEVOLUÇÃO ===================================
// ==================================================================

// Variáveis globais para paginação da tabela detalhada
let allDevolucaoProdutos = [];
let allDevolucaoMotivos = [];
let devolucaoCurrentPage = 1;
const devolucaoRowsPerPage = 20;

function initializeDevolucaoPage() {
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(() => {
        try {
            const today = new Date();
            const firstDayMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('dev-endDate').value = today.toISOString().split('T')[0];
            document.getElementById('dev-startDate').value = firstDayMonth.toISOString().split('T')[0];
            
            document.getElementById('dev-applyButton').addEventListener('click', applyDevolucaoDateFilter);
            document.getElementById('dev-date-range-toggle').addEventListener('click', (e) => toggleDatePopup(e, 'dev-date-range-popup'));
            document.getElementById('dev-cancelButton').addEventListener('click', (e) => toggleDatePopup(e, 'dev-date-range-popup'));
            updateDevolucaoDateRangeDisplay();
            
            document.getElementById('dev-detalhada-prev-page').addEventListener('click', () => {
                if (devolucaoCurrentPage > 1) {
                    devolucaoCurrentPage--;
                    renderDevolucaoDetalhadaPage();
                }
            });
            document.getElementById('dev-detalhada-next-page').addEventListener('click', () => {
                if (devolucaoCurrentPage * devolucaoRowsPerPage < allDevolucaoProdutos.length) {
                    devolucaoCurrentPage++;
                    renderDevolucaoDetalhadaPage();
                }
            });

            fetchDevolucaoData();

        } catch (error) {
            displayError("Erro ao inicializar o Dashboard de Devolução", error);
        }
    });
}

function updateDevolucaoDateRangeDisplay() {
    const startDate = new Date(document.getElementById('dev-startDate').value.replace(/-/g, '/'));
    const endDate = new Date(document.getElementById('dev-endDate').value.replace(/-/g, '/'));
    const options = { day: '2-digit', month: 'short', year: 'numeric' };
    const display = `${startDate.toLocaleDateString('pt-BR', options)} - ${endDate.toLocaleDateString('pt-BR', options)}`;
    document.getElementById('dev-date-range-display').textContent = display;
}

function applyDevolucaoDateFilter() {
    document.getElementById('dev-date-range-popup').classList.remove('show');
    updateDevolucaoDateRangeDisplay();
    pageCache.data.devolucao = null; 
    fetchDevolucaoData();
}

function fetchDevolucaoData() {
    if (pageCache.data.devolucao) {
        onDevolucaoDataReceived(pageCache.data.devolucao);
        return;
    }

    const loader = document.getElementById('devolucao-loader');
    const content = document.getElementById('devolucao-content');
    if (loader) loader.style.display = 'block';
    if (content) content.style.visibility = 'hidden';

    const dateRange = {
        start: document.getElementById('dev-startDate').value,
        end: document.getElementById('dev-endDate').value
    };

    google.script.run
        .withSuccessHandler(onDevolucaoDataReceived)
        .withFailureHandler(error => displayError('Falha ao buscar dados de Devolução', error))
        .getDevolucaoData(dateRange);
}

function onDevolucaoDataReceived(data) {
    if (data.error) {
        displayError('Erro ao processar dados de Devolução', { message: data.error });
        return;
    }
    pageCache.data.devolucao = data;

    const loader = document.getElementById('devolucao-loader');
    const content = document.getElementById('devolucao-content');
    if (loader) loader.style.display = 'none';
    if (content) content.style.visibility = 'visible';

    document.getElementById('kpi-total-devolvido').textContent = (data.kpis.totalDevolvido || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('kpi-valor-cancelamento').textContent = (data.kpis.valorCancelamento || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('kpi-devolucoes-unicas').textContent = data.kpis.devolucoesUnicas || 0;
    document.getElementById('kpi-itens-devolvidos').textContent = data.kpis.totalItensDevolvidos || 0;
    
    renderMotivosCards('top-motivos-container', data.topMotivos, data.kpis.devolucoesUnicas);
    renderTopList('top-categorias-container', data.topCategorias, '#059669', false);
    renderTopList('top-fabricantes-container', data.topFabricantes, '#d97706');

    drawDevolucoesChart(data.devolucoesPorMes);

    allDevolucaoProdutos = data.tabelaDetalhada.produtos || [];
    allDevolucaoMotivos = data.tabelaDetalhada.motivos || [];
    devolucaoCurrentPage = 1;
    renderDevolucaoDetalhadaPage();
}

function renderMotivosCards(containerId, motivosData, totalDevolucoes) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    if (!motivosData || motivosData.length === 0 || totalDevolucoes === 0) {
        container.innerHTML = '<p class="text-sm text-slate-500">Nenhum motivo encontrado.</p>';
        return;
    }

    motivosData.forEach(([motivo, data]) => {
        const { quantidade, valor, quantidadeAnterior } = data;
        
        const percentage = (quantidade / totalDevolucoes) * 100;
        const valorFormatado = (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        let trendIndicatorHtml = '';
        const diff = quantidade - quantidadeAnterior;

        if (diff > 0) {
            trendIndicatorHtml = `
                <span class="flex items-center text-xs font-semibold text-red-500" title="Comparado ao período anterior">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 15l7-7 7 7" /></svg>
                    +${diff}
                </span>`;
        } else if (diff < 0) {
            trendIndicatorHtml = `
                <span class="flex items-center text-xs font-semibold text-emerald-500" title="Comparado ao período anterior">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7" /></svg>
                    ${diff}
                </span>`;
        } else {
             trendIndicatorHtml = `
                <span class="flex items-center text-xs font-semibold text-slate-400" title="Comparado ao período anterior">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 12h14" /></svg>
                </span>`;
        }

        const cardHtml = `
            <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
                <h4 class="font-semibold text-slate-800 truncate text-sm" title="${motivo}">${motivo}</h4>
                <div class="mt-2 pt-2 border-t border-slate-200">
                    <div class="flex justify-between items-baseline">
                        <span class="text-2xl font-bold text-orange-600">${quantidade}</span>
                        <div class="flex items-center gap-2">
                           ${trendIndicatorHtml}
                           <span class="text-sm font-semibold text-slate-500">${percentage.toFixed(1)}%</span>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 text-left mt-1">Valor: ${valorFormatado}</p>
                </div>
            </div>`;
        container.innerHTML += cardHtml;
    });
}


function renderTopList(containerId, data, barColor, isProduct = false) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-sm text-slate-500">Nenhum dado encontrado.</p>';
        return;
    }

    const maxCount = data[0][1];

    data.forEach(([item, count]) => {
        const percentage = (count / maxCount) * 100;
        const shortItem = isProduct && item.length > 50 ? item.substring(0, 50) + '...' : item;
        
        const listItem = `
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="font-medium text-slate-700" title="${item}">${shortItem}</span>
                    <span class="font-bold text-slate-800">${count}</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-1.5">
                    <div class="h-1.5 rounded-full" style="width: ${percentage}%; background-color: ${barColor};"></div>
                </div>
            </div>
        `;
        container.innerHTML += listItem;
    });
}

function drawDevolucoesChart(chartData) {
    const chartDiv = document.getElementById('devolucoes-mes-chart');
    if (!chartDiv) return;

    if (!chartData || chartData.length <= 1) {
        chartDiv.innerHTML = '<p class="text-center py-10 text-slate-500">Não há dados suficientes para gerar o gráfico.</p>';
        return;
    }
    
    // CORREÇÃO: Usar a nova contagem de NF-e no tooltip e nos eixos do gráfico.
    const dataArray = [
        ['Mês', 'Valor Devolvido (R$)', { role: 'annotation' }, 'Devoluções (NF-e)', { role: 'annotation' }]
    ];

    chartData.slice(1).forEach(([mes, valor, quantidade]) => {
        const annotationValor = valor > 0 ? valor.toLocaleString('pt-BR', { notation: 'compact', compactDisplay: 'short' }) : '';
        const annotationQtd = quantidade > 0 ? quantidade.toString() : '';
        dataArray.push([mes, valor, annotationValor, quantidade, annotationQtd]);
    });

    const dataTable = google.visualization.arrayToDataTable(dataArray);
    const textStyle = { color: '#1e293b', fontName: 'Inter', fontSize: 12 };

    const options = {
        fontName: 'Inter',
        legend: { position: 'top', maxLines: 3, textStyle: textStyle },
        seriesType: 'bars',
        series: {
            0: { type: 'line', color: '#FF6000', targetAxisIndex: 0, lineWidth: 3, pointSize: 6, pointShape: 'circle' },
            1: { type: 'bars', color: '#00529e', targetAxisIndex: 1 }
        },
        vAxes: {
            0: { title: 'Valor Devolvido (R$)', format: 'short', textStyle: textStyle, titleTextStyle: { ...textStyle, bold: true, italic: false }, gridlines: { color: '#e2e8f0' }, viewWindow: { min: 0 } },
            1: { title: 'Devoluções (NF-e)', gridlines: { color: 'transparent' }, textStyle: textStyle, titleTextStyle: { ...textStyle, bold: true, italic: false }, viewWindow: { min: 0 } }
        },
        hAxis: { textStyle: textStyle, titleTextStyle: { ...textStyle, bold: true, italic: false } },
        chartArea: { left: 100, top: 60, width: '85%', height: '65%' },
        bar: { groupWidth: '60%' },
        focusTarget: 'category',
        animation: { startup: false },
        annotations: { alwaysOutside: true, textStyle: { fontName: 'Inter', fontSize: 11, color: '#1e293b', auraColor: '#ffffff' }, stem: { color: 'transparent' } }
    };

    const chart = new google.visualization.ComboChart(chartDiv);
    chart.draw(dataTable, options);
}

function renderDevolucaoDetalhadaPage() {
    const startIndex = (devolucaoCurrentPage - 1) * devolucaoRowsPerPage;
    const endIndex = startIndex + devolucaoRowsPerPage;
    const pageProdutos = allDevolucaoProdutos.slice(startIndex, endIndex);

    const pageDetails = {
        motivos: allDevolucaoMotivos,
        produtos: pageProdutos
    };

    renderDevolucaoDetalhadaTable(pageDetails);

    const pageInfo = document.getElementById('dev-detalhada-page-info');
    const prevBtn = document.getElementById('dev-detalhada-prev-page');
    const nextBtn = document.getElementById('dev-detalhada-next-page');

    if (allDevolucaoProdutos.length > 0) {
        pageInfo.textContent = `${startIndex + 1} - ${Math.min(endIndex, allDevolucaoProdutos.length)} de ${allDevolucaoProdutos.length}`;
    } else {
        pageInfo.textContent = '';
    }
    
    prevBtn.disabled = devolucaoCurrentPage === 1;
    nextBtn.disabled = endIndex >= allDevolucaoProdutos.length;
}

function renderDevolucaoDetalhadaTable(detalhes) {
    const thead = document.getElementById('devolucao-detalhada-thead');
    const tbody = document.getElementById('devolucao-detalhada-tbody');

    if (!thead || !tbody || !detalhes) {
        if(tbody) tbody.innerHTML = '<tr><td colspan="99">Erro ao carregar dados detalhados.</td></tr>';
        return;
    }

    thead.innerHTML = '';
    tbody.innerHTML = '';

    if (!detalhes.produtos || detalhes.produtos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-slate-500">Nenhum item devolvido no período selecionado.</td></tr>';
        thead.innerHTML = `
            <tr>
                <th class="p-3">CF</th>
                <th class="p-3">Produto</th>
                <th class="p-3">Total Retornado</th>
            </tr>
        `;
        return;
    }

    const cabecalhosMotivos = detalhes.motivos || [];
    let headerHtml = '<tr>';
    headerHtml += '<th class="p-3">CF</th>';
    headerHtml += '<th class="p-3">Produto</th>';
    headerHtml += '<th class="p-3 text-center">Total Retornado</th>';
    cabecalhosMotivos.forEach(motivo => {
        headerHtml += `<th class="p-3 text-center">${motivo}</th>`;
    });
    headerHtml += '</tr>';
    thead.innerHTML = headerHtml;

    let bodyHtml = '';
    detalhes.produtos.forEach(produto => {
        const nomeProdutoCurto = produto.nome.length > 80 ? produto.nome.substring(0, 80) + '...' : produto.nome;

        bodyHtml += `<tr class="border-b hover:bg-slate-50">`;
        bodyHtml += `<td class="p-3 font-mono text-xs">${produto.cf}</td>`;
        bodyHtml += `<td class="p-3" title="${produto.nome}">${nomeProdutoCurto}</td>`;
        bodyHtml += `<td class="p-3 font-bold text-center">${produto.total}</td>`;

        cabecalhosMotivos.forEach(motivo => {
            const contagem = produto.motivos[motivo] || 0;
            bodyHtml += `<td class="p-3 text-center">${contagem}</td>`;
        });

        bodyHtml += `</tr>`;
    });

    tbody.innerHTML = bodyHtml;
}

</script>

