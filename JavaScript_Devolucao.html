<script>
// ==================================================================
// === LÓGICA DA PÁGINA DEVOLUÇÃO ===================================
// ==================================================================

function initializeDevolucaoPage() {
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(() => {
        try {
            const today = new Date();
            const firstDayMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('dev-endDate').value = today.toISOString().split('T')[0];
            document.getElementById('dev-startDate').value = firstDayMonth.toISOString().split('T')[0];
            
            document.getElementById('dev-applyButton').addEventListener('click', applyDevolucaoDateFilter);
            document.getElementById('dev-date-range-toggle').addEventListener('click', (e) => toggleDatePopup(e, 'dev-date-range-popup'));
            document.getElementById('dev-cancelButton').addEventListener('click', (e) => toggleDatePopup(e, 'dev-date-range-popup'));
            updateDevolucaoDateRangeDisplay();
            
            fetchDevolucaoData();

        } catch (error) {
            displayError("Erro ao inicializar o Dashboard de Devolução", error);
        }
    });
}

function updateDevolucaoDateRangeDisplay() {
    const startDate = new Date(document.getElementById('dev-startDate').value.replace(/-/g, '/'));
    const endDate = new Date(document.getElementById('dev-endDate').value.replace(/-/g, '/'));
    const options = { day: '2-digit', month: 'short', year: 'numeric' };
    const display = `${startDate.toLocaleDateString('pt-BR', options)} - ${endDate.toLocaleDateString('pt-BR', options)}`;
    document.getElementById('dev-date-range-display').textContent = display;
}

function applyDevolucaoDateFilter() {
    document.getElementById('dev-date-range-popup').classList.remove('show');
    updateDevolucaoDateRangeDisplay();
    pageCache.data.devolucao = null; // Invalida o cache
    fetchDevolucaoData();
}

function fetchDevolucaoData() {
    if (pageCache.data.devolucao) {
        onDevolucaoDataReceived(pageCache.data.devolucao);
        return;
    }

    const loader = document.getElementById('devolucao-loader');
    const content = document.getElementById('devolucao-content');
    if (loader) loader.style.display = 'block';
    if (content) content.style.visibility = 'hidden';

    const dateRange = {
        start: document.getElementById('dev-startDate').value,
        end: document.getElementById('dev-endDate').value
    };

    google.script.run
        .withSuccessHandler(onDevolucaoDataReceived)
        .withFailureHandler(error => displayError('Falha ao buscar dados de Devolução', error))
        .getDevolucaoData(dateRange);
}

function onDevolucaoDataReceived(data) {
    if (data.error) {
        displayError('Erro ao processar dados de Devolução', { message: data.error });
        return;
    }
    pageCache.data.devolucao = data;

    const loader = document.getElementById('devolucao-loader');
    const content = document.getElementById('devolucao-content');
    if (loader) loader.style.display = 'none';
    if (content) content.style.visibility = 'visible';

    // Atualiza KPIs
    document.getElementById('kpi-total-devolvido').textContent = (data.kpis.totalDevolvido || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('kpi-valor-cancelamento').textContent = (data.kpis.totalCancelado || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('kpi-pedidos-devolucao').textContent = data.kpis.pedidosComDevolucao || 0;
    document.getElementById('kpi-itens-devolvidos').textContent = data.kpis.totalItensDevolvidos || 0;
    
    // Renderiza as listas
    renderTopList('top-motivos-container', data.topMotivos, '#4f46e5');
    renderTopList('top-produtos-container', data.topProdutos, '#059669', true);
    renderTopList('top-fabricantes-container', data.topFabricantes, '#d97706');

    // Desenha o gráfico
    drawDevolucoesChart(data.devolucoesPorMes);

    // Renderiza a nova tabela detalhada
    renderDevolucaoDetalhadaTable(data.devolucaoDetalhada);
}

function renderTopList(containerId, data, barColor, isProduct = false) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-sm text-slate-500">Nenhum dado encontrado.</p>';
        return;
    }

    const maxCount = data[0][1];

    data.forEach(([item, count]) => {
        const percentage = (count / maxCount) * 100;
        const shortItem = isProduct && item.length > 50 ? item.substring(0, 50) + '...' : item;
        
        const listItem = `
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="font-medium text-slate-700" title="${item}">${shortItem}</span>
                    <span class="font-bold text-slate-800">${count}</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-1.5">
                    <div class="h-1.5 rounded-full" style="width: ${percentage}%; background-color: ${barColor};"></div>
                </div>
            </div>
        `;
        container.innerHTML += listItem;
    });
}

/**
 * NOVA VERSÃO DA FUNÇÃO DO GRÁFICO - REESCRITA PARA ESTABILIDADE
 */
function drawDevolucoesChart(chartData) {
    const chartDiv = document.getElementById('devolucoes-mes-chart');
    if (!chartDiv) return;

    if (!chartData || chartData.length <= 1) {
        chartDiv.innerHTML = '<p class="text-center py-10 text-slate-500">Não há dados suficientes para gerar o gráfico.</p>';
        return;
    }
    
    // Etapa 1: Converter os dados brutos para um formato estável que a biblioteca entende.
    const dataArray = [
        ['Mês', 'Valor Devolvido (R$)', { role: 'annotation' }, 'Pedidos Únicos', { role: 'annotation' }]
    ];

    chartData.slice(1).forEach(([mes, valor, quantidade]) => {
        const annotationValor = valor > 0 ? valor.toLocaleString('pt-BR', { notation: 'compact', compactDisplay: 'short' }) : '';
        const annotationQtd = quantidade > 0 ? quantidade.toString() : '';
        dataArray.push([mes, valor, annotationValor, quantidade, annotationQtd]);
    });

    const dataTable = google.visualization.arrayToDataTable(dataArray);

    const textStyle = { color: '#1e293b', fontName: 'Inter', fontSize: 12 };

    // Etapa 2: Definir as opções de visualização, focando em estabilidade.
    const options = {
        fontName: 'Inter',
        legend: { position: 'top', maxLines: 3, textStyle: textStyle },
        seriesType: 'bars',
        series: {
            0: { // Valor (linha)
                type: 'line', 
                color: '#FF6000', 
                targetAxisIndex: 0,
                lineWidth: 3,
                pointSize: 6,
                pointShape: 'circle',
            },
            1: { // Pedidos Únicos (barras)
                type: 'bars', 
                color: '#00529e', 
                targetAxisIndex: 1 
            }
        },
        vAxes: {
            0: { 
                title: 'Valor Devolvido (R$)', 
                format: 'short', 
                textStyle: textStyle,
                titleTextStyle: { ...textStyle, bold: true, italic: false },
                gridlines: { color: '#e2e8f0' },
                viewWindow: { min: 0 }
            },
            1: { 
                title: 'Pedidos Únicos com Devolução', 
                gridlines: { color: 'transparent' }, 
                textStyle: textStyle,
                titleTextStyle: { ...textStyle, bold: true, italic: false },
                viewWindow: { min: 0 }
            }
        },
        hAxis: { 
            textStyle: textStyle,
            titleTextStyle: { ...textStyle, bold: true, italic: false }
        },
        chartArea: { left: 100, top: 60, width: '85%', height: '65%' },
        bar: { groupWidth: '60%' },
        // Usar o tooltip padrão, que é mais rápido e não causa travamentos.
        focusTarget: 'category',
        // Desativar animações para garantir performance máxima.
        animation: {
            startup: false,
        },
        annotations: {
            alwaysOutside: true,
            textStyle: {
                fontName: 'Inter',
                fontSize: 11,
                color: '#1e293b',
                auraColor: '#ffffff' 
            },
            stem: {
                color: 'transparent'
            }
        }
    };

    // Etapa 3: Desenhar o gráfico.
    const chart = new google.visualization.ComboChart(chartDiv);
    chart.draw(dataTable, options);
}

function renderDevolucaoDetalhadaTable(detalhes) {
    const thead = document.getElementById('devolucao-detalhada-thead');
    const tbody = document.getElementById('devolucao-detalhada-tbody');

    if (!thead || !tbody || !detalhes) {
        if(tbody) tbody.innerHTML = '<tr><td colspan="99">Erro ao carregar dados detalhados.</td></tr>';
        return;
    }

    // Limpa conteúdo anterior
    thead.innerHTML = '';
    tbody.innerHTML = '';

    if (!detalhes.linhas || detalhes.linhas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-slate-500">Nenhum item devolvido no período selecionado.</td></tr>';
        // Still render a minimal header
        thead.innerHTML = `
            <tr>
                <th class="p-3">CF</th>
                <th class="p-3">Produto</th>
                <th class="p-3">Total Retornado</th>
            </tr>
        `;
        return;
    }

    // Monta o cabeçalho dinamicamente
    const cabecalhosMotivos = detalhes.cabecalhos || [];
    let headerHtml = '<tr>';
    headerHtml += '<th class="p-3">CF</th>';
    headerHtml += '<th class="p-3">Produto</th>';
    headerHtml += '<th class="p-3 text-center">Total Retornado</th>';
    cabecalhosMotivos.forEach(motivo => {
        headerHtml += `<th class="p-3 text-center">${motivo}</th>`;
    });
    headerHtml += '</tr>';
    thead.innerHTML = headerHtml;

    // Monta as linhas da tabela
    let bodyHtml = '';
    detalhes.linhas.forEach(produto => {
        // Limita o nome do produto para não quebrar o layout
        const nomeProdutoCurto = produto.nome.length > 80 ? produto.nome.substring(0, 80) + '...' : produto.nome;

        bodyHtml += `<tr class="border-b hover:bg-slate-50">`;
        bodyHtml += `<td class="p-3 font-mono text-xs">${produto.cf}</td>`;
        bodyHtml += `<td class="p-3" title="${produto.nome}">${nomeProdutoCurto}</td>`;
        bodyHtml += `<td class="p-3 font-bold text-center">${produto.total}</td>`;

        // Itera sobre os cabeçalhos para garantir a ordem correta das colunas de motivo
        cabecalhosMotivos.forEach(motivo => {
            const contagem = produto.motivos[motivo] || 0;
            bodyHtml += `<td class="p-3 text-center">${contagem}</td>`;
        });

        bodyHtml += `</tr>`;
    });

    tbody.innerHTML = bodyHtml;
}

</script>

