<script>
// ==================================================================
// === LÓGICA DA PÁGINA DEVOLUÇÃO (COM FILTRO INTERATIVO OTIMIZADO) =
// ==================================================================

// Variáveis de paginação para a tabela de produtos detalhada
let allDevolucaoProdutos = [];
let allDevolucaoMotivos = [];
let devolucaoCurrentPage = 1;
const devolucaoRowsPerPage = 20;

// Variáveis de paginação para a nova tabela de pedidos
let allPedidosDevolucao = [];
let pedidosDevolucaoCurrentPage = 1;
const pedidosDevolucaoRowsPerPage = 20;

// Variável para guardar dados do modal para exportação
let currentMotivoDetailData = [];

// NOVAS Variáveis para o filtro interativo do gráfico diário
let fullDailyBreakdown = [];
let originalDevolucaoPageData = null;
let selectedDayFilter = null;
let dailyReturnsChart; // Referência global para o objeto do gráfico

function initializeDevolucaoPage() {
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(() => {
        try {
            const today = new Date();
            const firstDayMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('dev-endDate').value = today.toISOString().split('T')[0];
            document.getElementById('dev-startDate').value = firstDayMonth.toISOString().split('T')[0];
            
            // Listeners do filtro de data e exportação
            document.getElementById('dev-applyButton').addEventListener('click', applyDevolucaoDateFilter);
            document.getElementById('dev-date-range-toggle').addEventListener('click', (e) => toggleDatePopup(e, 'dev-date-range-popup'));
            document.getElementById('dev-cancelButton').addEventListener('click', (e) => toggleDatePopup(e, 'dev-date-range-popup'));
            document.getElementById('export-devolucao-motivos-btn').addEventListener('click', exportDevolucaoMotivosData);
            updateDevolucaoDateRangeDisplay();
            
            // Listener para o novo botão de limpar filtro
            document.getElementById('devolucao-clear-filter-btn').addEventListener('click', clearDailyFilter);
            
            // Listeners da paginação da tabela de produtos
            document.getElementById('dev-detalhada-prev-page').addEventListener('click', () => {
                if (devolucaoCurrentPage > 1) {
                    devolucaoCurrentPage--;
                    renderDevolucaoDetalhadaPage();
                }
            });
            document.getElementById('dev-detalhada-next-page').addEventListener('click', () => {
                if (devolucaoCurrentPage * devolucaoRowsPerPage < allDevolucaoProdutos.length) {
                    devolucaoCurrentPage++;
                    renderDevolucaoDetalhadaPage();
                }
            });

            // Listeners da paginação da nova tabela de pedidos
            document.getElementById('pedidos-devolucao-prev-page').addEventListener('click', () => {
                if (pedidosDevolucaoCurrentPage > 1) {
                    pedidosDevolucaoCurrentPage--;
                    renderPedidosDevolucaoPage();
                }
            });
            document.getElementById('pedidos-devolucao-next-page').addEventListener('click', () => {
                if (pedidosDevolucaoCurrentPage * pedidosDevolucaoRowsPerPage < allPedidosDevolucao.length) {
                    pedidosDevolucaoCurrentPage++;
                    renderPedidosDevolucaoPage();
                }
            });

            fetchDevolucaoData();

        } catch (error) {
            displayError("Erro ao inicializar o Dashboard de Devolução", error);
        }
    });
}

function updateDevolucaoDateRangeDisplay() {
    const startDate = new Date(document.getElementById('dev-startDate').value.replace(/-/g, '/'));
    const endDate = new Date(document.getElementById('dev-endDate').value.replace(/-/g, '/'));
    const options = { day: '2-digit', month: 'short', year: 'numeric' };
    const display = `${startDate.toLocaleDateString('pt-BR', options)} - ${endDate.toLocaleDateString('pt-BR', options)}`;
    document.getElementById('dev-date-range-display').textContent = display;
}

function applyDevolucaoDateFilter() {
    document.getElementById('dev-date-range-popup').classList.remove('show');
    updateDevolucaoDateRangeDisplay();
    pageCache.data.devolucaoPageData = null; 
    pageCache.data.devolucaoBreakdown = null;
    fetchDevolucaoData();
}

function fetchDevolucaoData() {
    if (pageCache.data.devolucaoPageData && pageCache.data.devolucaoBreakdown) {
        onAllDevolucaoDataReceived(pageCache.data.devolucaoPageData, pageCache.data.devolucaoBreakdown);
        return;
    }

    const loader = document.getElementById('devolucao-loader');
    const content = document.getElementById('devolucao-content');
    if (loader) loader.style.display = 'block';
    if (content) content.style.visibility = 'hidden';

    const dateRange = {
        start: document.getElementById('dev-startDate').value,
        end: document.getElementById('dev-endDate').value
    };

    const mainDataPromise = new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getDevolucaoPageDataWithCache(dateRange);
    });

    const breakdownDataPromise = new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getDevolucaoDailyBreakdownWithCache(dateRange);
    });

    Promise.all([mainDataPromise, breakdownDataPromise])
        .then(([mainData, breakdownData]) => {
            onAllDevolucaoDataReceived(mainData, breakdownData);
        })
        .catch(error => {
            displayError('Falha ao buscar dados completos de Devolução', error);
        });
}

function onAllDevolucaoDataReceived(mainData, breakdownData) {
    if (mainData.error) {
        displayError('Erro ao carregar dados principais de Devolução', { message: mainData.error });
        return;
    }
     if (breakdownData.error) {
        displayError('Erro ao carregar dados detalhados de Devolução', { message: breakdownData.error });
        return;
    }
    
    pageCache.data.devolucaoPageData = mainData;
    pageCache.data.devolucaoBreakdown = breakdownData;

    const loader = document.getElementById('devolucao-loader');
    const content = document.getElementById('devolucao-content');
    if (loader) loader.style.display = 'none';
    if (content) content.style.visibility = 'visible';

    originalDevolucaoPageData = {
        topMotivos: mainData.topMotivos,
        totalDevolucoes: mainData.kpis.devolucoesUnicas
    };
    fullDailyBreakdown = breakdownData || [];
    selectedDayFilter = null;
    clearDailyFilter();

    document.getElementById('kpi-total-devolvido').textContent = (mainData.kpis.totalDevolvido || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('kpi-valor-cancelamento').textContent = (mainData.kpis.valorCancelamento || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('kpi-devolucoes-unicas').textContent = mainData.kpis.devolucoesUnicas || 0;
    document.getElementById('kpi-itens-devolvidos').textContent = mainData.kpis.totalItensDevolvidos || 0;
    
    renderMotivosCards('top-motivos-container', mainData.topMotivos, mainData.kpis.devolucoesUnicas);
    renderTopList('top-categorias-container', mainData.topCategorias, '#059669', false);
    renderTopList('top-fabricantes-container', mainData.topFabricantes, '#d97706');

    drawDevolucoesChart(mainData.devolucoesPorMes);
    drawDevolucoesDiariasChart(mainData.devolucoesPorDia);

    allDevolucaoProdutos = mainData.tabelaDetalhada.produtos || [];
    allDevolucaoMotivos = mainData.tabelaDetalhada.motivos || [];
    devolucaoCurrentPage = 1;
    renderDevolucaoDetalhadaPage();

    allPedidosDevolucao = mainData.tabelaPedidos || [];
    pedidosDevolucaoCurrentPage = 1;
    renderPedidosDevolucaoPage();
}

function renderMotivosCards(containerId, motivosData, totalDevolucoes) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    if (!motivosData || motivosData.length === 0) {
        container.innerHTML = '<p class="text-sm text-slate-500 p-4 text-center">Nenhum motivo encontrado para a seleção.</p>';
        return;
    }

    const maxCount = motivosData.length > 0 ? motivosData[0][1].quantidade : 0;

    motivosData.forEach(([motivo, data]) => {
        const { quantidade, valor, quantidadeAnterior } = data;
        const percentageOfTotal = totalDevolucoes > 0 ? (quantidade / totalDevolucoes) * 100 : 0;
        const proportionalWidth = maxCount > 0 ? (quantidade / maxCount) * 100 : 0;
        const valorFormatado = (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        let trendIndicatorHtml = '';
        if (!selectedDayFilter) {
            const diff = quantidade - quantidadeAnterior;
            if (diff > 0) {
                trendIndicatorHtml = `<span class="flex items-center text-xs font-semibold text-red-500" title="Comparado ao período anterior"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 15l7-7 7 7" /></svg>+${diff}</span>`;
            } else if (diff < 0) {
                trendIndicatorHtml = `<span class="flex items-center text-xs font-semibold text-emerald-500" title="Comparado ao período anterior"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7" /></svg>${diff}</span>`;
            } else {
                trendIndicatorHtml = `<span class="flex items-center text-xs font-semibold text-slate-400" title="Comparado ao período anterior"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 12h14" /></svg></span>`;
            }
        }

        const card = document.createElement('div');
        card.className = 'bg-slate-50 border border-slate-200 rounded-lg p-3 flex flex-col h-full cursor-pointer hover:shadow-md hover:border-orange-300 transition-all';
        card.onclick = () => openMotivoDetailModal(motivo);

        card.innerHTML = `
            <h4 class="font-semibold text-slate-800 truncate text-sm" title="${motivo}">${motivo}</h4>
            <div class="mt-2 pt-2 border-t border-slate-200 flex-grow">
                <div class="flex justify-between items-baseline">
                    <span class="text-2xl font-bold text-orange-600">${quantidade}</span>
                    <div class="flex items-center gap-2">
                       ${trendIndicatorHtml}
                       <span class="text-sm font-semibold text-slate-500">${percentageOfTotal.toFixed(1)}%</span>
                    </div>
                </div>
                <p class="text-xs text-slate-500 text-left mt-1">Valor: ${valorFormatado}</p>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-1.5 mt-2">
                <div class="bg-orange-500 h-1.5 rounded-full" style="width: ${proportionalWidth}%"></div>
            </div>`;
        container.appendChild(card);
    });
}


function renderTopList(containerId, data, barColor, isProduct = false) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';
    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-sm text-slate-500">Nenhum dado encontrado.</p>';
        return;
    }
    const maxCount = data[0][1];
    data.forEach(([item, count]) => {
        const percentage = (count / maxCount) * 100;
        const shortItem = isProduct && item.length > 50 ? item.substring(0, 50) + '...' : item;
        const listItem = `
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="font-medium text-slate-700" title="${item}">${shortItem}</span>
                    <span class="font-bold text-slate-800">${count}</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-1.5">
                    <div class="h-1.5 rounded-full" style="width: ${percentage}%; background-color: ${barColor};"></div>
                </div>
            </div>`;
        container.innerHTML += listItem;
    });
}

function drawDevolucoesChart(chartData) {
    const chartDiv = document.getElementById('devolucoes-mes-chart');
    if (!chartDiv) return;
    if (!chartData || chartData.length <= 1) {
        chartDiv.innerHTML = '<p class="text-center py-10 text-slate-500">Não há dados suficientes para gerar o gráfico.</p>';
        return;
    }
    const dataArray = [
        ['Mês', 'Valor Devolvido (R$)', { role: 'annotation' }, 'Devoluções (NF-e)', { role: 'annotation' }, { role: 'tooltip', type: 'string', p: { html: true } }]
    ];
    chartData.slice(1).forEach(([mes, valor, quantidade]) => {
        const annotationValor = valor > 0 ? valor.toLocaleString('pt-BR', { notation: 'compact', compactDisplay: 'short' }) : '';
        const annotationQtd = quantidade > 0 ? quantidade.toString() : '';
        const valorFormatado = valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const tooltipHtml = `
            <div style="padding:10px; font-family: Inter, sans-serif; font-size: 12px; min-width: 150px;">
                <div style="font-weight: bold; margin-bottom: 5px;">${mes}</div>
                <div style="display: flex; align-items: center; margin-top: 5px;"><span style="height: 10px; width: 10px; background-color: #00529e; border-radius: 50%; display: inline-block; margin-right: 8px;"></span><span><strong>${quantidade}</strong> Devoluções (NF-e)</span></div>
                <div style="display: flex; align-items: center; margin-top: 5px;"><span style="height: 10px; width: 10px; background-color: #ff6000; border-radius: 50%; display: inline-block; margin-right: 8px;"></span><span><strong>${valorFormatado}</strong> Devolvidos</span></div>
            </div>`;
        dataArray.push([mes, valor, annotationValor, quantidade, annotationQtd, tooltipHtml]);
    });
    const dataTable = google.visualization.arrayToDataTable(dataArray);
    const textStyle = { color: '#475569', fontName: 'Inter', fontSize: 12 };
    const options = {
        fontName: 'Inter',
        legend: { position: 'top', maxLines: 3, textStyle: { ...textStyle, color: '#1e293b'} },
        seriesType: 'bars',
        series: {
            0: { type: 'line', color: '#ff6000', targetAxisIndex: 0, lineWidth: 3, pointSize: 6, pointShape: 'circle', curveType: 'function',
                annotations: { stem: { length: -15 }, textStyle: { color: '#ff6000', fontSize: 11, bold: true, auraColor: 'white' } }
            },
            1: { type: 'bars', color: '#00529e', targetAxisIndex: 1,
                annotations: { textStyle: { fontSize: 11, color: '#1e293b', auraColor: 'white' } }
            }
        },
        vAxes: {
            0: { title: 'Valor Devolvido (R$)', format: 'short', textStyle: textStyle, titleTextStyle: { ...textStyle, color: '#1e293b', bold: true, italic: false }, gridlines: { color: '#e2e8f0' }, viewWindow: { min: 0 } },
            1: { title: 'Devoluções (NF-e)', format: '0', gridlines: { color: 'transparent' }, textStyle: textStyle, titleTextStyle: { ...textStyle, color: '#1e293b', bold: true, italic: false }, viewWindow: { min: 0 } }
        },
        hAxis: { textStyle: textStyle },
        backgroundColor: { fill: 'transparent' },
        chartArea: { left: 100, top: 60, width: '80%', height: '65%' },
        bar: { groupWidth: '50%' },
        tooltip: { isHtml: true },
        animation: { startup: true, duration: 1000, easing: 'out' },
        annotations: { alwaysOutside: true }
    };
    const chart = new google.visualization.ComboChart(chartDiv);
    google.visualization.events.addListener(chart, 'ready', function () {
        const legend = chartDiv.getElementsByTagName('text');
        for (let i = 0; i < legend.length; i++) {
            if (legend[i].textContent === 'Valor Devolvido (R$)') legend[i].setAttribute('fill', '#ff6000');
            if (legend[i].textContent === 'Devoluções (NF-e)') legend[i].setAttribute('fill', '#00529e');
        }
    });
    chart.draw(dataTable, options);
}

function drawDevolucoesDiariasChart(chartData) {
    const chartDiv = document.getElementById('devolucoes-dia-chart');
    if (!chartDiv) return;
    if (!chartData || chartData.length <= 1) {
        chartDiv.innerHTML = '<p class="text-center py-10 text-slate-500">Não há dados diários de devolução para o período.</p>';
        return;
    }

    const dataArray = [
        ['Dia', 'Total Devoluções', { role: 'annotation' }, 'Cancelamentos', { role: 'annotation' }, { role: 'id' }, { role: 'tooltip', type: 'string', p: { html: true } }]
    ];
    chartData.slice(1).forEach(([day, total, cancellations, dateId]) => {
        const tooltipHtml = `
            <div style="padding:10px; font-family: Inter, sans-serif; font-size: 12px; min-width: 150px;">
                <div style="font-weight: bold; margin-bottom: 5px;">${day}</div>
                <div style="display: flex; align-items: center; margin-top: 5px;"><span style="height: 10px; width: 10px; background-color: #00529e; border-radius: 50%; display: inline-block; margin-right: 8px;"></span><span><strong>${total}</strong> Devoluções Totais</span></div>
                <div style="display: flex; align-items: center; margin-top: 5px;"><span style="height: 10px; width: 10px; background-color: #ff6000; border-radius: 50%; display: inline-block; margin-right: 8px;"></span><span><strong>${cancellations}</strong> Cancelamentos</span></div>
            </div>`;
        dataArray.push([day, total, total > 0 ? total.toString() : '', cancellations, cancellations > 0 ? cancellations.toString() : '', dateId, tooltipHtml]);
    });

    const dataTable = google.visualization.arrayToDataTable(dataArray);
    const textStyle = { color: '#475569', fontName: 'Inter', fontSize: 12 };
    const options = {
        fontName: 'Inter',
        legend: { position: 'top', alignment: 'center', textStyle: textStyle },
        seriesType: 'bars',
        series: {
            0: { color: '#00529e', annotations: { textStyle: { color: '#1e293b', bold: true, auraColor: 'white' } } }, 
            1: { type: 'line', color: '#ff6000', lineWidth: 3, pointSize: 6, pointShape: 'circle', annotations: { textStyle: { color: '#ff6000', bold: true, auraColor: 'white' } } }
        },
        vAxis: {
            title: 'Quantidade (NF-e)', format: '0', textStyle: textStyle,
            titleTextStyle: { ...textStyle, color: '#1e293b', bold: true, italic: false },
            gridlines: { color: '#e2e8f0' }, viewWindow: { min: 0 }
        },
        hAxis: { textStyle: textStyle, slantedText: chartData.length > 20, slantedTextAngle: 45 },
        backgroundColor: { fill: 'transparent' },
        chartArea: { left: 60, top: 50, width: '90%', height: '70%' },
        tooltip: { isHtml: true, trigger: 'focus' },
        animation: { startup: true, duration: 1000, easing: 'out' },
        annotations: { alwaysOutside: true, textStyle: { fontSize: 11 } }
    };

    dailyReturnsChart = new google.visualization.ComboChart(chartDiv);
    google.visualization.events.addListener(dailyReturnsChart, 'select', onDailyChartSelect);
    dailyReturnsChart.draw(dataTable, options);
}

function onDailyChartSelect() {
    if (!dailyReturnsChart || !pageCache.data.devolucaoPageData) return;
    const selection = dailyReturnsChart.getSelection();
    if (selection.length > 0) {
        const { row } = selection[0];
        if (row !== null) {
            const dataTable = google.visualization.arrayToDataTable(pageCache.data.devolucaoPageData.devolucoesPorDia);
            const dateId = dataTable.getValue(row, 3);

            if (selectedDayFilter === dateId) {
                clearDailyFilter();
            } else {
                selectedDayFilter = dateId;
                filterAndRerenderMotivos(dateId);
            }
        }
    }
}

function clearDailyFilter() {
    selectedDayFilter = null;
    if (originalDevolucaoPageData) {
        renderMotivosCards('top-motivos-container', originalDevolucaoPageData.topMotivos, originalDevolucaoPageData.totalDevolucoes);
    }
    document.getElementById('devolucao-motivo-filter-status').style.display = 'none';
    if(dailyReturnsChart) dailyReturnsChart.setSelection([]);
}

function filterAndRerenderMotivos(date) {
    if (!date) {
        clearDailyFilter();
        return;
    }

    const returnsForDay = fullDailyBreakdown.filter(item => item.d === date);
    const motivosDoDia = {};
    const nfsUnicasDoDia = new Set();

    returnsForDay.forEach(item => {
        const motivo = item.m;
        if (!motivosDoDia[motivo]) {
            motivosDoDia[motivo] = { nfs: new Set(), valor: 0 };
        }
        if (item.nf) {
            motivosDoDia[motivo].nfs.add(item.nf);
            nfsUnicasDoDia.add(item.nf);
        }
        motivosDoDia[motivo].valor += item.v;
    });
    
    const topMotivosDoDia = Object.entries(motivosDoDia).map(([motivo, data]) => {
        const displayMotivo = motivo.charAt(0).toUpperCase() + motivo.slice(1);
        return [displayMotivo, { quantidade: data.nfs.size, valor: data.valor, quantidadeAnterior: 0 }];
    }).sort(([, a], [, b]) => b.quantidade - a.quantidade).slice(0, 4);

    const totalDevolucoesDia = nfsUnicasDoDia.size;
    renderMotivosCards('top-motivos-container', topMotivosDoDia, totalDevolucoesDia);

    const statusContainer = document.getElementById('devolucao-motivo-filter-status');
    const statusText = document.getElementById('devolucao-motivo-filter-text');
    const [year, month, day] = date.split('-');
    statusText.textContent = `Filtrando por: ${day}/${month}/${year}`;
    statusContainer.style.display = 'flex';
}

function renderDevolucaoDetalhadaPage() {
    const startIndex = (devolucaoCurrentPage - 1) * devolucaoRowsPerPage;
    const endIndex = startIndex + devolucaoRowsPerPage;
    const pageProdutos = allDevolucaoProdutos.slice(startIndex, endIndex);
    const pageDetails = { motivos: allDevolucaoMotivos, produtos: pageProdutos };
    renderDevolucaoDetalhadaTable(pageDetails);
    const pageInfo = document.getElementById('dev-detalhada-page-info');
    const prevBtn = document.getElementById('dev-detalhada-prev-page');
    const nextBtn = document.getElementById('dev-detalhada-next-page');
    if (allDevolucaoProdutos.length > 0) pageInfo.textContent = `${startIndex + 1} - ${Math.min(endIndex, allDevolucaoProdutos.length)} de ${allDevolucaoProdutos.length}`;
    else pageInfo.textContent = '';
    prevBtn.disabled = devolucaoCurrentPage === 1;
    nextBtn.disabled = endIndex >= allDevolucaoProdutos.length;
}

function renderDevolucaoDetalhadaTable(detalhes) {
    const thead = document.getElementById('devolucao-detalhada-thead');
    const tbody = document.getElementById('devolucao-detalhada-tbody');
    if (!thead || !tbody || !detalhes) { if(tbody) tbody.innerHTML = '<tr><td colspan="99">Erro ao carregar dados.</td></tr>'; return; }
    thead.innerHTML = ''; tbody.innerHTML = '';
    if (!detalhes.produtos || detalhes.produtos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-slate-500">Nenhum item devolvido no período.</td></tr>';
        thead.innerHTML = `<tr><th class="p-3">CF</th><th class="p-3">Produto</th><th class="p-3">Total Retornado</th></tr>`;
        return;
    }
    const cabecalhosMotivos = detalhes.motivos || [];
    let headerHtml = '<tr><th class="p-3">CF</th><th class="p-3">Produto</th><th class="p-3 text-center">Total Retornado</th>';
    cabecalhosMotivos.forEach(motivo => { headerHtml += `<th class="p-3 text-center">${motivo}</th>`; });
    headerHtml += '</tr>';
    thead.innerHTML = headerHtml;
    let bodyHtml = '';
    detalhes.produtos.forEach(produto => {
        const nomeProdutoCurto = produto.nome.length > 80 ? produto.nome.substring(0, 80) + '...' : produto.nome;
        bodyHtml += `<tr class="border-b hover:bg-slate-50"><td class="p-3 font-mono text-xs">${produto.cf}</td><td class="p-3" title="${produto.nome}">${nomeProdutoCurto}</td><td class="p-3 font-bold text-center">${produto.total}</td>`;
        cabecalhosMotivos.forEach(motivo => {
            const contagem = produto.motivos[motivo] || 0;
            bodyHtml += `<td class="p-3 text-center">${contagem}</td>`;
        });
        bodyHtml += `</tr>`;
    });
    tbody.innerHTML = bodyHtml;
}

function renderPedidosDevolucaoPage() {
    const tbody = document.getElementById('pedidos-devolucao-tbody');
    const pageInfo = document.getElementById('pedidos-devolucao-page-info');
    const prevBtn = document.getElementById('pedidos-devolucao-prev-page');
    const nextBtn = document.getElementById('pedidos-devolucao-next-page');

    if (!tbody) return;
    tbody.innerHTML = '';

    if (allPedidosDevolucao.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-500">Nenhum pedido com devolução no período.</td></tr>';
        pageInfo.textContent = '0 de 0';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
    }

    const startIndex = (pedidosDevolucaoCurrentPage - 1) * pedidosDevolucaoRowsPerPage;
    const endIndex = startIndex + pedidosDevolucaoRowsPerPage;
    const pagePedidos = allPedidosDevolucao.slice(startIndex, endIndex);

    let tableHtml = '';
    pagePedidos.forEach(pedido => {
        const valorFormatado = (pedido.totalValorDevolvido || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        tableHtml += `
            <tr class="border-b hover:bg-slate-50">
                <td class="p-3">${pedido.pedidoId}</td>
                <td class="p-3">${pedido.dataNfe}</td>
                <td class="p-3 truncate" title="${pedido.cliente}">${pedido.cliente}</td>
                <td class="p-3 text-center">
                    <span class="font-semibold text-blue-600 cursor-pointer hover:underline" onclick="openItensDevolvidosModal('${pedido.pedidoId}')">
                        ${pedido.totalItensDevolvidos}
                    </span>
                </td>
                <td class="p-3 font-semibold">${valorFormatado}</td>
            </tr>
        `;
    });
    tbody.innerHTML = tableHtml;

    pageInfo.textContent = `${startIndex + 1} - ${Math.min(endIndex, allPedidosDevolucao.length)} de ${allPedidosDevolucao.length}`;
    prevBtn.disabled = pedidosDevolucaoCurrentPage === 1;
    nextBtn.disabled = endIndex >= allPedidosDevolucao.length;
}

function openItensDevolvidosModal(pedidoId) {
    const modal = document.getElementById('itens-modal');
    const modalContent = document.getElementById('itens-modal-content');
    document.getElementById('itens-modal-title').textContent = `Itens Devolvidos do Pedido ${pedidoId}`;
    
    const listContainer = document.getElementById('itens-modal-list');
    const totalValueEl = document.getElementById('itens-modal-total');
    
    listContainer.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Carregando itens...</td></tr>';
    totalValueEl.textContent = 'Calculando...';

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        modalContent.classList.remove('scale-95');
    }, 10);

    google.script.run
        .withSuccessHandler(function(items) {
            if (items.error) {
                 listContainer.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Erro: ${items.error}</td></tr>`;
                 return;
            }
            
            listContainer.innerHTML = '';
            let totalValue = 0;

            if (!items || items.length === 0) {
                listContainer.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Nenhum item encontrado.</td></tr>';
            } else {
                items.forEach(item => {
                    const valorFormatado = (item.valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    totalValue += item.valor || 0;
                    const itemHtml = `
                        <tr class="border-b">
                            <td class="p-2 align-top font-mono text-xs">${item.cf}</td>
                            <td class="p-2 align-top">${item.descricao}</td>
                            <td class="p-2 align-top text-center">${item.quantidade}</td>
                            <td class="p-2 align-top text-right">${valorFormatado}</td>
                        </tr>
                    `;
                    listContainer.innerHTML += itemHtml;
                });
            }
            totalValueEl.textContent = totalValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        })
        .withFailureHandler(function(error) {
            listContainer.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Falha ao buscar itens: ${error.message}</td></tr>`;
        })
        .getItensDevolvidosPorPedidoWithCache(pedidoId);
}


function closeItensDevolvidosModal() {
    const modal = document.getElementById('itens-modal');
    const modalContent = document.getElementById('itens-modal-content');
    modal.classList.add('opacity-0');
    modalContent.classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }, 300);
}

function exportDevolucaoMotivosData() {
    const button = document.getElementById('export-devolucao-motivos-btn');
    const originalText = button.innerHTML;
    button.innerHTML = `
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Exportando...</span>`;
    button.disabled = true;

    const dateRange = {
        start: document.getElementById('dev-startDate').value,
        end: document.getElementById('dev-endDate').value
    };

    google.script.run
        .withSuccessHandler(function(exportData) {
            if (exportData.error) {
                alert('Erro ao exportar dados: ' + exportData.error);
                button.innerHTML = originalText;
                button.disabled = false;
                return;
            }

            if (!exportData || exportData.length === 0) {
                alert('Não há dados para exportar no período selecionado.');
                button.innerHTML = originalText;
                button.disabled = false;
                return;
            }

            const headers = ['Data NFE', 'NFe Numero', 'Pedido', 'Cliente', 'Produto', 'Qtd Devolvida', 'Valor Devolucao', 'Motivo'];
            const csvRows = [headers, ...exportData];
            
            const startDate = document.getElementById('dev-startDate').value;
            const endDate = document.getElementById('dev-endDate').value;

            exportToCsv(`devolucoes_detalhadas_${startDate}_a_${endDate}.csv`, csvRows);
            
            button.innerHTML = originalText;
            button.disabled = false;
        })
        .withFailureHandler(function(error) {
            alert('Falha ao exportar dados: ' + error.message);
            button.innerHTML = originalText;
            button.disabled = false;
        })
        .getDevolucaoExportDataWithCache(dateRange);
}

function exportToCsv(filename, rows) {
    if (!rows || rows.length === 0) { 
        alert('Não há dados para exportar.'); 
        return; 
    }
    const processRow = (row) => {
        return row.map(val => {
            let innerValue = val === null || val === undefined ? '' : String(val);
            if (val instanceof Date) { 
                innerValue = val.toLocaleString('pt-BR'); 
            }
            if (typeof val === 'number') {
                innerValue = String(val).replace('.', ',');
            }
            let result = innerValue.replace(/"/g, '""');
            if (result.search(/("|,|\n)/g) >= 0) { 
                result = '"' + result + '"'; 
            }
            return result;
        }).join(';');
    };
    const csvContent = rows.map(processRow).join('\n');
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function togglePedidoDetails(pedidoId) {
    const detailRows = document.querySelectorAll(`.detail-row-${pedidoId}`);
    const icon = document.getElementById(`icon-${pedidoId}`);
    detailRows.forEach(row => {
        row.classList.toggle('hidden');
    });
    if (icon) {
        icon.classList.toggle('rotate-90');
    }
}

// MODIFICADO: Passa o filtro de dia (se ativo) para a função do backend
function openMotivoDetailModal(motivo) {
    currentMotivoDetailData = [];
    const modal = document.getElementById('motivo-detail-modal');
    const modalContent = document.getElementById('motivo-detail-modal-content');
    document.getElementById('motivo-detail-title').textContent = `Pedidos: ${motivo}`;

    document.getElementById('motivo-detail-loader').style.display = 'block';
    document.getElementById('motivo-detail-table-container').classList.add('hidden');
    
    const exportBtn = document.getElementById('export-motivo-detail-btn');
    exportBtn.disabled = true;
    exportBtn.onclick = null;

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        modalContent.classList.remove('scale-95');
    }, 10);

    const dateRange = {
        start: document.getElementById('dev-startDate').value,
        end: document.getElementById('dev-endDate').value
    };

    // Passa 'selectedDayFilter' como terceiro argumento. Será nulo se nenhum dia estiver filtrado.
    google.script.run
        .withSuccessHandler(function(pedidos) {
            document.getElementById('motivo-detail-loader').style.display = 'none';
            const tableContainer = document.getElementById('motivo-detail-table-container');
            tableContainer.classList.remove('hidden');
            const tbody = document.getElementById('motivo-detail-table-body');
            tbody.innerHTML = '';

            if (pedidos.error) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Erro: ${pedidos.error}</td></tr>`;
                return;
            }
            
            currentMotivoDetailData = pedidos;
            if (!pedidos || pedidos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-slate-500">Nenhum pedido encontrado para este motivo no período.</td></tr>';
                exportBtn.disabled = true;
                return;
            }
            
            exportBtn.disabled = false;
            exportBtn.onclick = () => exportMotivoDetails(motivo);

            let fragment = document.createDocumentFragment();
            pedidos.forEach(p => {
                const hasMultipleProducts = p.produtos.length > 1;
                const pedidoIdLimpo = p.pedidoId.replace(/[^a-zA-Z0-9]/g, '');

                const mainRow = document.createElement('tr');
                mainRow.className = 'border-b border-slate-200';
                
                let mainRowContent = `
                    <td class="p-3 align-top">${p.pedidoId}</td>
                    <td class="p-3 align-top">${p.dataNfe}</td>
                    <td class="p-3 align-top" title="${p.cliente}">${p.cliente}</td>
                `;

                if (hasMultipleProducts) {
                    mainRow.classList.add('hover:bg-slate-50', 'cursor-pointer');
                    mainRow.onclick = () => togglePedidoDetails(pedidoIdLimpo);
                    mainRowContent += `
                        <td class="p-3 align-top">
                            <div class="flex items-center text-slate-600">
                                ${p.produtos.length} produtos 
                                <svg id="icon-${pedidoIdLimpo}" class="w-4 h-4 text-slate-500 ml-2 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </div>
                        </td>
                        <td class="p-3 align-top">${p.justificativa}</td>
                    `;
                } else {
                     mainRowContent += `
                        <td class="p-3 align-top">${p.produtos[0] || 'N/A'}</td>
                        <td class="p-3 align-top">${p.justificativa}</td>
                    `;
                }
                mainRow.innerHTML = mainRowContent;
                fragment.appendChild(mainRow);
                
                if (hasMultipleProducts) {
                    p.produtos.forEach(produto => {
                        const detailRow = document.createElement('tr');
                        detailRow.className = `detail-row-${pedidoIdLimpo} hidden`;
                        detailRow.innerHTML = `<td colspan="3"></td><td colspan="2" class="py-2 px-3 pl-10 text-slate-600 bg-slate-50 border-b border-slate-200">${produto}</td>`;
                        fragment.appendChild(detailRow);
                    });
                }
            });
            tbody.appendChild(fragment);
        })
        .withFailureHandler(function(error) {
            document.getElementById('motivo-detail-loader').style.display = 'none';
            const tbody = document.getElementById('motivo-detail-table-body');
            tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Falha ao buscar detalhes: ${error.message}</td></tr>`;
        })
        .getPedidosPorMotivoWithCache(dateRange, motivo, selectedDayFilter);
}

function exportMotivoDetails(motivo) {
    if (!currentMotivoDetailData || currentMotivoDetailData.length === 0) {
        alert('Não há dados para exportar.');
        return;
    }
    const headers = ['Pedido', 'Data NFE', 'Cliente', 'Produto', 'Justificativa'];
    const rows = [headers];
    currentMotivoDetailData.forEach(pedido => {
        if (pedido.produtos.length > 0) {
            pedido.produtos.forEach((produto, index) => {
                if (index === 0) {
                    rows.push([pedido.pedidoId, pedido.dataNfe, pedido.cliente, produto, pedido.justificativa]);
                } else {
                    rows.push(['', '', '', produto, '']);
                }
            });
        } else {
            rows.push([pedido.pedidoId, pedido.dataNfe, pedido.cliente, '', pedido.justificativa]);
        }
    });

    const filename = `pedidos_motivo_${motivo.replace(/\s+/g, '_').toLowerCase()}.csv`;
    exportToCsv(filename, rows);
}


function closeMotivoDetailModal() {
    const modal = document.getElementById('motivo-detail-modal');
    const modalContent = document.getElementById('motivo-detail-modal-content');
    modal.classList.add('opacity-0');
    modalContent.classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }, 300);
}
</script>

